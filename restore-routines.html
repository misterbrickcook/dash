<!DOCTYPE html>
<html>
<head>
    <title>Restore Routines - DashFin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .success, .info, .error {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        .success { background: #efe; color: #363; }
        .info { background: #eef; color: #336; }
        .error { background: #fee; color: #c33; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .routine-data {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h2>üîß Restore Routine Data</h2>
    <p>This will restore your routine streaks and clear duplicate entries.</p>
    
    <div id="status"></div>
    
    <button onclick="checkCurrentData()">1. Check Current Data</button>
    <button onclick="restoreRoutines()">2. Restore Routines</button>
    <button onclick="cleanupData()">3. Cleanup Duplicates</button>
    
    <div id="data-display"></div>

    <script>
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML += `<div class="${type}">${message}</div>`;
        }
        
        function checkCurrentData() {
            const status = document.getElementById('data-display');
            
            // Check localStorage routine data
            const routineCompletionData = localStorage.getItem('routineCompletionData');
            const routineResetTime = localStorage.getItem('routineResetTime');
            const lastRoutineResetDate = localStorage.getItem('lastRoutineResetDate');
            
            let html = '<h3>Current Routine Data:</h3>';
            
            if (routineCompletionData) {
                try {
                    const data = JSON.parse(routineCompletionData);
                    html += `<div class="routine-data">
                        <strong>Completion Data:</strong><br>
                        ${JSON.stringify(data, null, 2)}
                    </div>`;
                } catch (e) {
                    html += `<div class="error">Error parsing completion data: ${e.message}</div>`;
                }
            } else {
                html += `<div class="error">No routine completion data found</div>`;
            }
            
            html += `<div class="routine-data">
                <strong>Reset Time:</strong> ${routineResetTime || 'Not set'}<br>
                <strong>Last Reset Date:</strong> ${lastRoutineResetDate || 'Not set'}
            </div>`;
            
            status.innerHTML = html;
        }
        
        function restoreRoutines() {
            // Get existing data
            const routineCompletionData = localStorage.getItem('routineCompletionData');
            
            if (!routineCompletionData) {
                log('No routine data to restore', 'error');
                return;
            }
            
            try {
                const oldData = JSON.parse(routineCompletionData);
                
                // Convert old format to new format
                const completions = [];
                const today = new Date().toISOString().split('T')[0];
                
                // Process morning routines
                if (oldData.morningRoutine) {
                    Object.keys(oldData.morningRoutine).forEach((routineId, index) => {
                        const templateId = `morning_${index + 1}`;
                        if (oldData.morningRoutine[routineId]) {
                            completions.push({
                                id: `${templateId}_${today}`,
                                template_id: templateId,
                                date: today,
                                completed: true,
                                user_id: 'restored'
                            });
                        }
                    });
                }
                
                // Process evening routines
                if (oldData.eveningRoutine) {
                    Object.keys(oldData.eveningRoutine).forEach((routineId, index) => {
                        const templateId = `evening_${index + 1}`;
                        if (oldData.eveningRoutine[routineId]) {
                            completions.push({
                                id: `${templateId}_${today}`,
                                template_id: templateId,
                                date: today,
                                completed: true,
                                user_id: 'restored'
                            });
                        }
                    });
                }
                
                // Save to new format
                localStorage.setItem('routine_completions_cache', JSON.stringify(completions));
                
                // Clean templates
                const templates = [
                    {id: 'morning_1', text: 'üíß Glas Wasser trinken', routine_type: 'morning', order_index: 1},
                    {id: 'morning_2', text: 'üßò 5 Min Meditation', routine_type: 'morning', order_index: 2},
                    {id: 'morning_3', text: 'üì± Handy Check vermeiden', routine_type: 'morning', order_index: 3},
                    {id: 'morning_4', text: '‚òÄÔ∏è Tageslicht tanken', routine_type: 'morning', order_index: 4},
                    {id: 'morning_5', text: 'üìù Tagesplan machen', routine_type: 'morning', order_index: 5},
                    {id: 'evening_1', text: 'üì± Handy weggelegen', routine_type: 'evening', order_index: 1},
                    {id: 'evening_2', text: 'üìñ 10 Min lesen', routine_type: 'evening', order_index: 2},
                    {id: 'evening_3', text: '‚úÖ Tag reflektieren', routine_type: 'evening', order_index: 3},
                    {id: 'evening_4', text: 'üåô Zimmer abdunkeln', routine_type: 'evening', order_index: 4},
                    {id: 'evening_5', text: 'üò¥ Fr√ºh ins Bett', routine_type: 'evening', order_index: 5}
                ];
                
                localStorage.setItem('routine_templates_cache', JSON.stringify(templates));
                
                log(`‚úÖ Restored ${completions.length} routine completions`, 'success');
                log('Templates cleaned and restored', 'success');
                
            } catch (error) {
                log(`Error restoring routines: ${error.message}`, 'error');
            }
        }
        
        function cleanupData() {
            // Remove old format data
            localStorage.removeItem('routineCompletionData');
            localStorage.removeItem('routines_cache');
            
            // Clean any duplicate keys
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('routine') && !key.includes('_cache') && !key.includes('ResetTime') && !key.includes('ResetDate')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log(`Removed: ${key}`, 'info');
            });
            
            log('‚úÖ Cleanup completed', 'success');
            log('<strong>Now refresh your dashboard!</strong>', 'success');
        }
    </script>
</body>
</html>