<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 HYBRID DASHBOARD - With Todo Filters! 🚀</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- === BEAUTIFUL STICKY NAVIGATION === -->
    <nav class="sticky-nav">
        <div class="nav-container">
            <div class="nav-link active" data-tab="home">Home</div>
            <div class="nav-link" data-tab="todos">ToDos</div>
            <div class="nav-link" data-tab="ziele">Ziele</div>
            <div class="nav-link" data-tab="journal">Journal</div>
            <div class="nav-link" data-tab="motivation">Motivation</div>
            <div class="nav-link" data-tab="ressourcen">Ressourcen</div>
            <div class="nav-link" data-tab="settings">Settings</div>
        </div>
    </nav>

    <div class="main-content">
        
        <!-- === 🏠 HOME TAB === -->
        <div class="tab-content active" id="home">
            <!-- 🔥 Streak Übersicht -->
            <section class="streak-overview">
                <div class="streak-grid">
                    <div class="streak-tile" id="morningRoutineStreak">
                        <div class="streak-number" id="morningRoutineStreakCount">0</div>
                        <div class="streak-label">Morgenroutine</div>
                        <div class="streak-date" id="morningRoutineStreakDate">August 2025</div>
                    </div>
                    <div class="streak-tile" id="eveningRoutineStreak">
                        <div class="streak-number" id="eveningRoutineStreakCount">0</div>
                        <div class="streak-label">Abendroutine</div>
                        <div class="streak-date" id="eveningRoutineStreakDate">August 2025</div>
                    </div>
                    <div class="streak-tile" id="todoStreak">
                        <div class="streak-number" id="todoStreakCount">0</div>
                        <div class="streak-label">Todo Streak</div>
                        <div class="streak-date" id="todoStreakDate">August 2025</div>
                    </div>
                </div>
            </section>

            <!-- ☀️ Routines Section -->
            <section class="section">
                <div class="card-header">
                    <h2 id="routine-title">☀️ Morgenroutine</h2>
                    <div class="focus-toggle">
                        <div class="focus-option active" data-routine="morning">☀️</div>
                        <div class="focus-option" data-routine="evening">🌙</div>
                    </div>
                </div>
                
                <!-- Cloud-synced routines -->
                <div class="checkbox-group" id="current-routine">
                    <div class="loading-placeholder" style="text-align: center; padding: 1rem; color: #666;">
                        ☁️ Loading routines from cloud...
                    </div>
                </div>
            </section>

            <!-- 📋 Heutige Aufgaben (Cloud-Synced) -->
            <section class="card">
                <div class="card-header">
                    <h2>📋 Heutige Aufgaben</h2>
                    <button id="add-todo-btn" style="padding: 0.3rem 0.8rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + Add Todo
                    </button>
                </div>
                
                <!-- Cloud-synced todos -->
                <div class="checkbox-group" id="home-todos">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ☁️ Loading todos from cloud...
                    </div>
                </div>
            </section>
        </div>

        <!-- === ✅ TODOS TAB === -->
        <div class="tab-content" id="todos">
            <section class="card">
                <div class="card-header">
                    <h2 id="todos-section-title">Active Todos</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="todo-category-select" style="padding: 0.3rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem;">
                            <option value="heute">Heute</option>
                            <option value="privat">Privat</option>
                            <option value="uni">Uni</option>
                            <option value="arbeit">Arbeit</option>
                        </select>
                        <button id="add-todo-btn-2" style="padding: 0.3rem 0.8rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            + Add Todo
                        </button>
                    </div>
                </div>
                
                <!-- Todo Filter Tabs -->
                <div class="filter-tabs" style="display: flex; gap: 0.5rem; margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <button class="filter-tab active" data-filter="alle" style="padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #007bff; color: white; cursor: pointer; font-size: 0.8rem;">Alle</button>
                    <button class="filter-tab" data-filter="heute" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;">📅 Heute</button>
                    <button class="filter-tab" data-filter="privat" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;">🏠 Privat</button>
                    <button class="filter-tab" data-filter="uni" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;">🎓 Uni</button>
                    <button class="filter-tab" data-filter="arbeit" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;">💼 Arbeit</button>
                </div>
                
                <div class="checkbox-group" id="active-todos">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ☁️ Loading active todos...
                    </div>
                </div>
            </section>

            <!-- Archived Section -->
            <section class="card" style="margin-top: 1rem;">
                <div class="card-header">
                    <h2>📁 Completed Todos</h2>
                    <small style="color: #666;">Auto-archived</small>
                </div>
                
                <div class="checkbox-group" id="archived-todos">
                    <div style="text-align: center; color: #666; padding: 1rem;">
                        📁 Completed todos will appear here
                    </div>
                </div>
            </section>
        </div>

        <!-- === 🎯 ZIELE TAB === -->
        <div class="tab-content" id="ziele">
            <section class="card">
                <div class="card-header">
                    <h2>🎯 Goals & Targets</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    🚧 Goals system coming soon with cloud sync!
                </div>
            </section>
        </div>

        <!-- === 📔 JOURNAL TAB === -->
        <div class="tab-content" id="journal">
            <section class="card">
                <div class="card-header">
                    <h2>📔 Daily Journal</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    📝 Journal system coming soon with cloud sync!
                </div>
            </section>
        </div>

        <!-- === ⚡ MOTIVATION TAB === -->
        <div class="tab-content" id="motivation">
            <section class="card">
                <div class="card-header">
                    <h2>⚡ Daily Motivation</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    💪 Motivation system coming soon!
                </div>
            </section>
        </div>

        <!-- === 📚 RESSOURCEN TAB === -->
        <div class="tab-content" id="ressourcen">
            <section class="card">
                <div class="card-header">
                    <h2>📚 Resources & Links</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    🔗 Resources coming soon!
                </div>
            </section>
        </div>

        <!-- === ⚙️ SETTINGS TAB === -->
        <div class="tab-content" id="settings">
            <section class="card">
                <div class="card-header">
                    <h2>⚙️ Settings</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    ⚙️ Settings panel coming soon!
                </div>
            </section>
        </div>

    </div>

    <!-- Scripts -->
    <script src="supabase-config.js?v=4"></script>
    <script src="cloud-storage.js?v=3"></script>
    <script src="script.js?v=3"></script>
    
    <!-- HYBRID SYSTEM: Beautiful UI + Working Cloud Sync -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 HYBRID DASHBOARD - Beautiful UI + Cloud Sync');
            
            // Initialize navigation
            initializeNavigation();
            
            // Initialize Supabase
            const connected = initializeSupabase();
            
            if (connected && window.supabase) {
                console.log('✅ Database connected - loading data...');
                await loadAndRenderTodos();
                await loadAndRenderRoutines();
                setupTodoButtons();
                setupRoutineToggles();
                await initializeStreaks();
            } else {
                // Even without database, setup filter tabs
                setupFilterTabs();
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.getAttribute('data-tab');
                    
                    // Remove active from all
                    navLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(t => t.classList.remove('active'));
                    
                    // Add active to clicked
                    link.classList.add('active');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                });
            });
        }
        
        async function loadAndRenderTodos() {
            try {
                const todos = await window.supabase.select('todos');
                console.log(`📊 Loaded ${todos?.length || 0} todos from cloud`);
                
                if (todos && todos.length > 0) {
                    renderTodos(todos);
                } else {
                    clearLoadingMessages();
                }
            } catch (error) {
                console.error('❌ Failed to load todos:', error);
            }
        }
        
        let currentFilter = 'alle';
        
        function renderTodos(todos) {
            const homeContainer = document.getElementById('home-todos');
            const activeContainer = document.getElementById('active-todos');
            const archivedContainer = document.getElementById('archived-todos');
            
            // Clear containers
            homeContainer.innerHTML = '';
            activeContainer.innerHTML = '';
            archivedContainer.innerHTML = '';
            
            const activeTodos = todos.filter(t => !t.completed);
            const completedTodos = todos.filter(t => t.completed);
            
            // Filter todos based on current filter
            const filteredActiveTodos = currentFilter === 'alle' 
                ? activeTodos 
                : activeTodos.filter(t => t.category === currentFilter);
            
            // Render active todos (filtered)
            filteredActiveTodos.forEach(todo => {
                const categoryIcon = getCategoryIcon(todo.category);
                const todoHTML = `
                    <div class="checkbox-item" data-category="${todo.category}">
                        <input type="checkbox" data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                        <label>${categoryIcon} ${todo.text}</label>
                        <span class="todo-category" style="margin-left: auto; color: #666; font-size: 0.7rem; text-transform: uppercase;">${todo.category}</span>
                    </div>
                `;
                activeContainer.insertAdjacentHTML('beforeend', todoHTML);
            });
            
            // Render home todos (heute category only)
            const heuteTodos = activeTodos.filter(t => t.category === 'heute');
            heuteTodos.forEach(todo => {
                const categoryIcon = getCategoryIcon(todo.category);
                const todoHTML = `
                    <div class="checkbox-item" data-category="${todo.category}">
                        <input type="checkbox" data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                        <label>${categoryIcon} ${todo.text}</label>
                    </div>
                `;
                homeContainer.insertAdjacentHTML('beforeend', todoHTML);
            });
            
            // Render completed todos
            completedTodos.forEach(todo => {
                const categoryIcon = getCategoryIcon(todo.category);
                const archivedHTML = `
                    <div class="checkbox-item" style="opacity: 0.7;" data-category="${todo.category}">
                        <input type="checkbox" checked disabled>
                        <label style="text-decoration: line-through; color: #999;">${categoryIcon} ${todo.text}</label>
                        <span style="margin-left: auto; color: #666; font-size: 0.8rem;">📁</span>
                    </div>
                `;
                archivedContainer.insertAdjacentHTML('beforeend', archivedHTML);
            });
            
            // Update section title
            const titleEl = document.getElementById('todos-section-title');
            if (titleEl) {
                titleEl.textContent = currentFilter === 'alle' ? 'Active Todos' : `${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} Todos`;
            }
            
            console.log(`✅ Rendered ${filteredActiveTodos.length} active (${currentFilter}), ${completedTodos.length} completed todos`);
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'heute': '📅',
                'privat': '🏠',
                'uni': '🎓',
                'arbeit': '💼'
            };
            return icons[category] || '📝';
        }
        
        function clearLoadingMessages() {
            document.querySelectorAll('.loading-placeholder').forEach(el => {
                el.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No todos yet - click + to add one!</div>';
            });
        }
        
        function setupFilterTabs() {
            console.log('🔧 Setting up filter tabs...');
            const filterTabs = document.querySelectorAll('.filter-tab');
            console.log(`Found ${filterTabs.length} filter tabs`);
            
            filterTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const filter = tab.getAttribute('data-filter');
                    console.log(`🔍 Filter clicked: ${filter}`);
                    
                    // Update active tab
                    filterTabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.background = 'white';
                        t.style.color = '#666';
                        t.style.border = '1px solid #ddd';
                    });
                    
                    tab.classList.add('active');
                    tab.style.background = '#007bff';
                    tab.style.color = 'white';
                    tab.style.border = 'none';
                    
                    // Update current filter and re-render
                    currentFilter = filter;
                    
                    // Re-render todos with new filter
                    if (window.supabase) {
                        loadAndRenderTodos();
                    }
                });
            });
        }
        
        function setupTodoButtons() {
            document.getElementById('add-todo-btn').addEventListener('click', addNewTodo);
            document.getElementById('add-todo-btn-2').addEventListener('click', addNewTodo);
            setupFilterTabs();
        }
        
        async function addNewTodo() {
            const todoText = prompt('Enter todo text:');
            if (!todoText) return;
            
            // Get selected category
            const categorySelect = document.getElementById('todo-category-select');
            const selectedCategory = categorySelect ? categorySelect.value : 'heute';
            
            const newTodo = {
                id: 'todo_' + Date.now(),
                text: todoText,
                completed: false,
                category: selectedCategory,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('todos', newTodo);
                console.log(`✅ Todo added to cloud (${selectedCategory}):`, todoText);
                await loadAndRenderTodos(); // Refresh
            } catch (error) {
                console.error('❌ Failed to add todo:', error);
            }
        }
        
        async function syncTodoChange(todoId, checked) {
            try {
                await window.supabase.update('todos', { completed: checked }, todoId);
                console.log(`☁️ Todo synced: ${todoId} = ${checked}`);
                
                // Refresh display
                setTimeout(async () => {
                    await loadAndRenderTodos();
                }, 300);
                
            } catch (error) {
                console.error('❌ Sync failed:', error);
            }
        }
        
        // === ROUTINES SYSTEM ===
        let currentRoutineType = 'morning';
        
        async function loadAndRenderRoutines() {
            try {
                // Load routine templates
                const templates = await window.supabase.select('routine_templates', '*');
                console.log(`📊 Loaded ${templates?.length || 0} routine templates`);
                
                if (templates && templates.length > 0) {
                    await renderCurrentRoutine(currentRoutineType);
                } else {
                    document.getElementById('current-routine').innerHTML = 
                        '<div style="text-align: center; color: #666; padding: 1rem;">No routines configured</div>';
                }
            } catch (error) {
                console.error('❌ Failed to load routines:', error);
            }
        }
        
        async function renderCurrentRoutine(routineType) {
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Get templates for this routine type
                const templates = await window.supabase.query(
                    `routine_templates?routine_type=eq.${routineType}&active=eq.true&order=order_index`
                );
                
                if (!templates || templates.length === 0) {
                    document.getElementById('current-routine').innerHTML = 
                        `<div style="text-align: center; color: #666; padding: 1rem;">No ${routineType} routine configured</div>`;
                    return;
                }
                
                // Get today's completions for these templates
                const completions = await window.supabase.query(
                    `routine_completions?date=eq.${today}`
                );
                
                const completionMap = {};
                if (completions) {
                    completions.forEach(comp => {
                        completionMap[comp.template_id] = comp.completed;
                    });
                }
                
                // Render routine items
                const routineContainer = document.getElementById('current-routine');
                routineContainer.innerHTML = '';
                
                templates.forEach(template => {
                    const isCompleted = completionMap[template.id] || false;
                    const routineHTML = `
                        <div class="checkbox-item">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   data-template-id="${template.id}" data-routine-type="${routineType}"
                                   onchange="syncRoutineChange('${template.id}', this.checked)">
                            <label style="${isCompleted ? 'text-decoration: line-through; color: #999;' : ''}">${template.text}</label>
                        </div>
                    `;
                    routineContainer.insertAdjacentHTML('beforeend', routineHTML);
                });
                
                console.log(`✅ Rendered ${templates.length} ${routineType} routine items`);
                
            } catch (error) {
                console.error('❌ Failed to render routine:', error);
            }
        }
        
        async function syncRoutineChange(templateId, completed) {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Check if completion record exists
                const existing = await window.supabase.query(
                    `routine_completions?template_id=eq.${templateId}&date=eq.${today}`
                );
                
                if (existing && existing.length > 0) {
                    // Update existing
                    await window.supabase.update('routine_completions', 
                        { completed: completed }, 
                        existing[0].id
                    );
                } else {
                    // Create new completion record
                    const newCompletion = {
                        id: `completion_${templateId}_${today}`,
                        template_id: templateId,
                        date: today,
                        completed: completed
                    };
                    await window.supabase.insert('routine_completions', newCompletion);
                }
                
                console.log(`☁️ Routine synced: ${templateId} = ${completed}`);
                
                // Update UI
                const checkbox = document.querySelector(`[data-template-id="${templateId}"]`);
                if (checkbox) {
                    const label = checkbox.nextElementSibling;
                    if (label) {
                        label.style.textDecoration = completed ? 'line-through' : '';
                        label.style.color = completed ? '#999' : '';
                    }
                }
                
                // Update streak counters instantly (optimistic UI)
                updateStreakInstantly(templateId, completed);
                
                // Also do full recalculation in background
                setTimeout(() => updateRoutineStreaks(), 200);
                
            } catch (error) {
                console.error('❌ Routine sync failed:', error);
            }
        }
        
        function setupRoutineToggles() {
            const morningToggle = document.querySelector('[data-routine="morning"]');
            const eveningToggle = document.querySelector('[data-routine="evening"]');
            const routineTitle = document.getElementById('routine-title');
            
            morningToggle?.addEventListener('click', async () => {
                currentRoutineType = 'morning';
                routineTitle.textContent = '☀️ Morgenroutine';
                
                // Update toggle states
                morningToggle.classList.add('active');
                eveningToggle?.classList.remove('active');
                
                await renderCurrentRoutine('morning');
            });
            
            eveningToggle?.addEventListener('click', async () => {
                currentRoutineType = 'evening';
                routineTitle.textContent = '🌙 Abendroutine';
                
                // Update toggle states
                eveningToggle.classList.add('active');
                morningToggle?.classList.remove('active');
                
                await renderCurrentRoutine('evening');
            });
        }
        
        async function updateRoutineStreaks() {
            try {
                console.log('📊 Calculating routine streaks...');
                
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
                                   'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                
                // Calculate morning routine streak for current month
                const morningStreak = await calculateMonthlyRoutineStreak('morning', currentYear, currentMonth);
                const eveningStreak = await calculateMonthlyRoutineStreak('evening', currentYear, currentMonth);
                
                // Update UI
                document.getElementById('morningRoutineStreakCount').textContent = morningStreak;
                document.getElementById('morningRoutineStreakDate').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                document.getElementById('eveningRoutineStreakCount').textContent = eveningStreak;
                document.getElementById('eveningRoutineStreakDate').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                console.log(`✅ Updated streaks: Morning ${morningStreak}, Evening ${eveningStreak}`);
                
            } catch (error) {
                console.error('❌ Failed to update streaks:', error);
            }
        }
        
        async function calculateMonthlyRoutineStreak(routineType, year, month) {
            try {
                // Get first and last day of month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const today = new Date();
                
                // Only count up to today if we're in current month
                const endDate = (year === today.getFullYear() && month === today.getMonth()) 
                    ? today : lastDay;
                
                let completedDays = 0;
                
                // Check each day in the month (up to today)
                for (let day = 1; day <= endDate.getDate(); day++) {
                    const checkDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    // Get all templates for this routine type
                    const templates = await window.supabase.query(
                        `routine_templates?routine_type=eq.${routineType}&active=eq.true`
                    );
                    
                    if (!templates || templates.length === 0) continue;
                    
                    // Get completions for this day
                    const completions = await window.supabase.query(
                        `routine_completions?date=eq.${checkDate}`
                    );
                    
                    // Check if ALL routine items for this type were completed
                    let allCompleted = true;
                    for (const template of templates) {
                        const completion = completions?.find(c => c.template_id === template.id);
                        if (!completion || !completion.completed) {
                            allCompleted = false;
                            break;
                        }
                    }
                    
                    if (allCompleted) {
                        completedDays++;
                    }
                }
                
                return completedDays;
                
            } catch (error) {
                console.error(`❌ Failed to calculate ${routineType} streak:`, error);
                return 0;
            }
        }
        
        // Initialize streaks on page load
        async function initializeStreaks() {
            await updateRoutineStreaks();
        }
        
        function updateStreakInstantly(templateId, completed) {
            // Get current streak values
            const morningStreakEl = document.getElementById('morningRoutineStreakCount');
            const eveningStreakEl = document.getElementById('eveningRoutineStreakCount');
            
            // Determine which routine type this template belongs to
            const checkbox = document.querySelector(`[data-template-id="${templateId}"]`);
            const routineType = checkbox?.getAttribute('data-routine-type');
            
            if (!routineType) return;
            
            // Check if all items of this routine type are now completed
            const allCheckboxes = document.querySelectorAll(`[data-routine-type="${routineType}"]`);
            let allCompleted = true;
            allCheckboxes.forEach(cb => {
                if (!cb.checked) allCompleted = false;
            });
            
            // Update streak counter instantly
            const streakEl = routineType === 'morning' ? morningStreakEl : eveningStreakEl;
            const currentStreak = parseInt(streakEl.textContent) || 0;
            
            if (completed && allCompleted) {
                // All items completed - increment streak
                streakEl.textContent = currentStreak + 1;
                console.log(`⚡ Instant streak update: ${routineType} +1`);
            } else if (!completed && currentStreak > 0) {
                // Item unchecked - decrement streak  
                streakEl.textContent = Math.max(0, currentStreak - 1);
                console.log(`⚡ Instant streak update: ${routineType} -1`);
            }
        }
    </script>
</body>
</html>