<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ CLEAN SLATE - CLOUD SYNC TEST üöÄ</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- === STICKY NAVIGATION === -->
    <nav class="sticky-nav">
        <div class="nav-container">
            <div class="nav-link active" data-tab="home">Home</div>
            <div class="nav-link" data-tab="todos">ToDos</div>
        </div>
    </nav>

    <div class="main-content">
        
        <!-- === üè† HOME TAB === -->
        <div class="tab-content active" id="home">
            <section class="card">
                <div class="card-header">
                    <h2>üöÄ Cloud Sync Test</h2>
                    <button id="add-todo-btn" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Add Test Todo
                    </button>
                </div>
                
                <!-- CLEAN: Only cloud todos -->
                <div class="checkbox-group" id="home-todos">
                    <div class="placeholder" style="text-align: center; color: #666; padding: 2rem;">
                        ‚òÅÔ∏è Ready for cloud sync test<br>
                        <small>Add a todo and test cross-device sync!</small>
                    </div>
                </div>
            </section>
        </div>

        <!-- === ‚úÖ TODOS TAB === -->
        <div class="tab-content" id="todos">
            <!-- Active Todos -->
            <section class="card">
                <div class="card-header">
                    <h2>Active Todos</h2>
                </div>
                
                <div class="checkbox-group" id="active-todos">
                    <div class="placeholder" style="text-align: center; color: #666; padding: 2rem;">
                        ‚òÅÔ∏è Active todos will appear here
                    </div>
                </div>
            </section>

            <!-- Archived Todos -->
            <section class="card" style="margin-top: 1rem;">
                <div class="card-header">
                    <h2>üìÅ Archived Todos</h2>
                    <small style="color: #666;">Auto-archived after completion</small>
                </div>
                
                <div class="checkbox-group" id="archived-todos">
                    <div class="placeholder" style="text-align: center; color: #666; padding: 2rem;">
                        ‚òÅÔ∏è Completed todos will be archived here
                    </div>
                </div>
            </section>
        </div>

    </div>

    <!-- Supabase Configuration -->
    <script src="supabase-config.js?v=4"></script>
    <!-- Cloud Storage System -->
    <script src="cloud-storage.js?v=3"></script>
    <!-- Main Application -->
    <script src="script.js?v=3"></script>
    
    <!-- CLEAN SLATE CLOUD SYNC -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ CLEAN SLATE - Initializing cloud sync...');
            
            // Initialize Supabase
            const connected = initializeSupabase();
            
            if (connected && window.supabase) {
                console.log('‚úÖ Database connected - ready for clean sync test');
                
                // Load existing todos from cloud
                const cloudTodos = await window.supabase.select('todos');
                console.log('üìä Existing cloud todos:', cloudTodos?.length || 0);
                
                // Render existing todos
                if (cloudTodos && cloudTodos.length > 0) {
                    renderCloudTodos(cloudTodos);
                }
                
                // Add todo functionality
                setupAddTodo();
            }
        });
        
        function renderCloudTodos(todos) {
            const homeContainer = document.getElementById('home-todos');
            const activeContainer = document.getElementById('active-todos');
            const archivedContainer = document.getElementById('archived-todos');
            
            // Clear containers
            homeContainer.innerHTML = '';
            activeContainer.innerHTML = '';
            archivedContainer.innerHTML = '';
            
            const activeTodos = todos.filter(t => !t.archived);
            const archivedTodos = todos.filter(t => t.archived);
            
            // Render active todos
            activeTodos.forEach(todo => {
                const todoHTML = `
                    <div class="checkbox-item">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                               data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                        <label style="${todo.completed ? 'text-decoration: line-through; color: #999;' : ''}">${todo.text}</label>
                        ${todo.completed ? '<span style="margin-left: auto; color: #666;">‚è≥ Archiving in 3s...</span>' : ''}
                    </div>
                `;
                
                homeContainer.insertAdjacentHTML('beforeend', todoHTML);
                activeContainer.insertAdjacentHTML('beforeend', todoHTML);
            });
            
            // Render archived todos  
            archivedTodos.forEach(todo => {
                const archivedHTML = `
                    <div class="checkbox-item" style="opacity: 0.7;">
                        <input type="checkbox" checked disabled>
                        <label style="text-decoration: line-through; color: #999;">${todo.text}</label>
                        <span style="margin-left: auto; color: #666; font-size: 0.8rem;">üìÅ Archived</span>
                    </div>
                `;
                
                archivedContainer.insertAdjacentHTML('beforeend', archivedHTML);
            });
            
            console.log(`‚úÖ Rendered ${activeTodos.length} active, ${archivedTodos.length} archived todos`);
        }
        
        function setupAddTodo() {
            document.getElementById('add-todo-btn').addEventListener('click', async () => {
                const todoText = prompt('Enter todo text:');
                if (!todoText) return;
                
                const newTodo = {
                    id: 'todo_' + Date.now(),
                    text: todoText,
                    completed: false,
                    category: 'test',
                    created_at: new Date().toISOString()
                };
                
                try {
                    await window.supabase.insert('todos', newTodo);
                    console.log('‚úÖ Todo added to cloud:', todoText);
                    
                    // Refresh display
                    const todos = await window.supabase.select('todos');
                    renderCloudTodos(todos);
                } catch (error) {
                    console.error('‚ùå Failed to add todo:', error);
                }
            });
        }
        
        async function syncTodoChange(todoId, checked) {
            try {
                await window.supabase.update('todos', { completed: checked }, todoId);
                console.log(`‚òÅÔ∏è Todo synced: ${todoId} = ${checked}`);
                
                // Update UI immediately
                const checkboxes = document.querySelectorAll(`[data-cloud-id="${todoId}"]`);
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    const label = cb.nextElementSibling;
                    if (label) {
                        label.style.textDecoration = checked ? 'line-through' : '';
                        label.style.color = checked ? '#999' : '';
                    }
                });
                
                // Auto-archive after 3 seconds
                if (checked) {
                    console.log(`‚è≥ Auto-archiving ${todoId} in 3 seconds...`);
                    
                    setTimeout(async () => {
                        try {
                            await window.supabase.update('todos', { archived: true }, todoId);
                            console.log(`üìÅ Todo archived: ${todoId}`);
                            
                            // Refresh display
                            const todos = await window.supabase.select('todos');
                            renderCloudTodos(todos);
                        } catch (error) {
                            console.error('‚ùå Archiving failed:', error);
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
            }
        }
    </script>
</body>
</html>