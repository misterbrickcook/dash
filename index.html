<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ HYBRID DASHBOARD - With Todo Filters! üöÄ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- === BEAUTIFUL STICKY NAVIGATION === -->
    <nav class="sticky-nav" style="display: none;">
        <div class="nav-container">
            <div class="nav-link active" data-tab="home">Home</div>
            <div class="nav-link" data-tab="todos">ToDos</div>
            <div class="nav-link" data-tab="ziele">Ziele</div>
            <div class="nav-link" data-tab="journal">Journal</div>
            <div class="nav-link" data-tab="motivation">Motivation</div>
            <div class="nav-link" data-tab="ressourcen">Ressourcen</div>
            <div class="nav-link" data-tab="settings">Settings</div>
            <div class="nav-link" data-tab="restore" style="display: none;">üîß Restore</div>
        </div>
    </nav>

    <!-- === üîê AUTH SCREEN === -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h2>üöÄ DashFin Dashboard</h2>
                <p>Please login to access your personal data</p>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Your password" required>
                </div>
                <button id="login-btn" class="auth-btn">Login</button>
                <div id="login-error" class="auth-error"></div>
            </div>
            
            <div class="auth-footer">
                <p>Your data is encrypted and stored securely.</p>
            </div>
        </div>
    </div>

    <div class="main-content" style="display: none;">
        <!-- User Info Bar -->
        <div id="user-info" class="user-info">
            <span id="user-email"></span>
            <button id="logout-btn" class="logout-btn">Logout</button>
        </div>
        
        <!-- === üè† HOME TAB === -->
        <div class="tab-content active" id="home">
            <!-- üî• Streak √úbersicht -->
            <section class="streak-overview">
                <div class="streak-grid">
                    <div class="streak-tile" id="morningRoutineStreak">
                        <div class="streak-number" id="morningRoutineStreakCount">0</div>
                        <div class="streak-label">Morgenroutine</div>
                        <div class="streak-date" id="morningRoutineStreakDate">August 2025</div>
                    </div>
                    <div class="streak-tile" id="eveningRoutineStreak">
                        <div class="streak-number" id="eveningRoutineStreakCount">0</div>
                        <div class="streak-label">Abendroutine</div>
                        <div class="streak-date" id="eveningRoutineStreakDate">August 2025</div>
                    </div>
                    <div class="streak-tile" id="todoStreak">
                        <div class="streak-number" id="todoStreakCount">0</div>
                        <div class="streak-label">Todo Streak</div>
                        <div class="streak-date" id="todoStreakDate">August 2025</div>
                    </div>
                </div>
            </section>

            <!-- üí≠ T√§gliches Zitat -->
            <section class="card" style="margin-bottom: 1rem;">
                <div style="text-align: center; padding: 1.5rem;">
                    <div style="font-size: 1.1rem; font-style: italic; color: #495057; line-height: 1.5; margin-bottom: 1rem;" id="dailyQuoteText">
                        "Der einzige Weg, gro√üartige Arbeit zu leisten, ist zu lieben, was du tust."
                    </div>
                    <div style="font-size: 0.9rem; color: #6c757d; font-weight: 500;" id="dailyQuoteAuthor">
                        ‚Äî Steve Jobs
                    </div>
                    <button onclick="getNewQuote()" class="btn-transparent" style="margin-top: 1rem; padding: 0.3rem 0.8rem; border-radius: 15px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s;">
                        üîÑ Neues Zitat
                    </button>
                </div>
            </section>

            <!-- ‚òÄÔ∏è Routines Section -->
            <section class="section">
                <div class="card-header">
                    <h2 id="routine-title">‚òÄÔ∏è Morgenroutine</h2>
                    <div class="focus-toggle">
                        <div class="focus-option active" data-routine="morning">‚òÄÔ∏è</div>
                        <div class="focus-option" data-routine="evening">üåô</div>
                    </div>
                </div>
                
                <!-- Cloud-synced routines -->
                <div class="checkbox-group" id="current-routine">
                    <div class="loading-placeholder" style="text-align: center; padding: 1rem; color: #666;">
                        ‚òÅÔ∏è Loading routines from cloud...
                    </div>
                </div>
            </section>

            <!-- üìã Heutige Aufgaben (Cloud-Synced) -->
            <section class="card">
                <div class="card-header">
                    <h2>üìã Heutige Aufgaben</h2>
                    <button id="add-todo-btn" class="btn-primary" style="padding: 0.3rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + Add Todo
                    </button>
                </div>
                
                <!-- Cloud-synced todos -->
                <div class="checkbox-group" id="home-todos">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading todos from cloud...
                    </div>
                </div>
            </section>
        </div>

        <!-- === ‚úÖ TODOS TAB === -->
        <div class="tab-content" id="todos">
            <section class="card">
                <div class="card-header">
                    <h2 id="todos-section-title">Active Todos</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="add-todo-btn-2" class="btn-primary" style="padding: 0.3rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            + Add Todo
                        </button>
                        <button id="clear-archive-btn" class="btn-danger" style="padding: 0.3rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: none;">
                            üóëÔ∏è Clear Archive
                        </button>
                    </div>
                </div>
                
                <!-- Todo Filter Tabs - Generated by JavaScript -->
                <div class="filter-tabs" style="display: flex; gap: 0.5rem; margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <!-- Filter tabs will be created dynamically -->
                </div>
                
                <div class="checkbox-group" id="active-todos">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading active todos...
                    </div>
                </div>
            </section>

            <!-- Note: Archived todos now available via "Archiv" filter tab -->
        </div>

        <!-- === üéØ ZIELE TAB === -->
        <div class="tab-content" id="ziele">
            <section class="card">
                <div class="card-header">
                    <h2 id="goals-section-title">üéØ Active Goals</h2>
                    <button id="add-goal-btn" class="btn-success" style="padding: 0.3rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + Add Goal
                    </button>
                </div>
                
                <!-- Goal Filter Tabs -->
                <div class="goal-filter-tabs" style="display: flex; gap: 0.5rem; margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <!-- Filter tabs will be created dynamically -->
                </div>
                
                <div class="checkbox-group" id="active-goals">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading goals from cloud...
                    </div>
                </div>
            </section>

            <!-- Note: Completed goals now available via "Erreicht" filter tab -->
        </div>

        <!-- === üìî JOURNAL TAB === -->
        <div class="tab-content" id="journal">
            <section class="card">
                <div class="card-header">
                    <h2 id="journal-section-title">üìî Daily Journal</h2>
                    <button id="add-journal-btn" class="btn-info" style="padding: 0.3rem 0.8rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + New Entry
                    </button>
                </div>
                
                <!-- Journal Filter Tabs -->
                <div class="journal-filter-tabs" style="display: flex; gap: 0.3rem; margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; flex-wrap: wrap;">
                    <!-- Filter tabs will be created dynamically -->
                </div>
                
                <div id="journal-entries">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading journal entries...
                    </div>
                </div>
            </section>
        </div>

        <!-- === ‚ö° MOTIVATION TAB === -->
        <div class="tab-content" id="motivation">
            <!-- üé¨ Motivations-Diashow -->
            <section class="card">
                <div class="card-header">
                    <h2>‚ö° T√§gliche Motivation</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button id="prevSlide" class="btn btn-small btn-transparent" style="padding: 0.5rem; border: none; font-size: 0.75rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15,18 9,12 15,6"></polyline>
                            </svg>
                        </button>
                        <div id="slideCounter" style="font-size: 0.8rem; color: var(--text-secondary); min-width: 50px; text-align: center;">1/5</div>
                        <button id="nextSlide" class="btn btn-small btn-transparent" style="padding: 0.5rem; border: none; font-size: 0.75rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </button>
                        <button id="autoPlayToggle" class="btn btn-small btn-dark" style="padding: 0.3rem 0.6rem; border: 1px solid var(--border-color); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Auto</button>
                    </div>
                </div>
                
                <!-- Slideshow Container -->
                <div class="slideshow-container" style="position: relative; max-width: 800px; margin: 0 auto; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                    
                    <!-- Slide 1 -->
                    <div class="motivational-slide active" style="display: flex; text-align: center; padding: 3rem 2rem; min-height: 300px; flex-direction: column; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div style="color: white; font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            Deine Tr√§ume sind gr√∂√üer als deine Ausreden
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; font-style: italic;">
                            ‚Äî Unbekannt
                        </div>
                    </div>
                    
                    <!-- Slide 2 -->
                    <div class="motivational-slide" style="display: none; text-align: center; padding: 3rem 2rem; min-height: 300px; flex-direction: column; justify-content: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div style="color: white; font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            Erfolg ist die Summe kleiner Anstrengungen
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; font-style: italic;">
                            ‚Äî Robert Collier
                        </div>
                    </div>
                    
                    <!-- Slide 3 -->
                    <div class="motivational-slide" style="display: none; text-align: center; padding: 3rem 2rem; min-height: 300px; flex-direction: column; justify-content: center; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div style="color: white; font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            Der beste Zeitpunkt war gestern.<br>Der zweitbeste ist jetzt.
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; font-style: italic;">
                            ‚Äî Chinesisches Sprichwort
                        </div>
                    </div>
                    
                    <!-- Slide 4 -->
                    <div class="motivational-slide" style="display: none; text-align: center; padding: 3rem 2rem; min-height: 300px; flex-direction: column; justify-content: center; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div style="color: white; font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            Gro√üe Tr√§ume brauchen gro√üe Taten
                        </div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; font-style: italic;">
                            ‚Äî Unbekannt
                        </div>
                    </div>
                    
                    <!-- Slide 5 -->
                    <div class="motivational-slide" style="display: none; text-align: center; padding: 3rem 2rem; min-height: 300px; flex-direction: column; justify-content: center; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <div style="color: #333; font-size: 2rem; font-weight: 600; margin-bottom: 1rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            Du wirst morgen sein, was du heute denkst
                        </div>
                        <div style="color: #666; font-size: 1rem; font-style: italic;">
                            ‚Äî Buddha
                        </div>
                    </div>
                    
                </div>
                
                <!-- Slide Indicators -->
                <div style="text-align: center; margin-top: 1rem;">
                    <div class="slide-indicators" style="display: inline-flex; gap: 0.5rem;">
                        <div class="indicator active" data-slide="0" style="width: 10px; height: 10px; border-radius: 50%; background: #333; cursor: pointer; opacity: 1; transition: all 0.3s ease;"></div>
                        <div class="indicator" data-slide="1" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;"></div>
                        <div class="indicator" data-slide="2" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;"></div>
                        <div class="indicator" data-slide="3" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;"></div>
                        <div class="indicator" data-slide="4" style="width: 10px; height: 10px; border-radius: 50%; background: #ccc; cursor: pointer; opacity: 0.5; transition: all 0.3s ease;"></div>
                    </div>
                </div>
                
            </section>
        </div>

        <!-- === üìö RESSOURCEN TAB === -->
        <div class="tab-content" id="ressourcen">
            <section class="card">
                <div class="card-header">
                    <h2>üìö Resources & Links</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    üîó Resources coming soon!
                </div>
            </section>
        </div>

        <!-- === ‚öôÔ∏è SETTINGS TAB === -->
        <div class="tab-content" id="settings">
            <section class="card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Settings</h2>
                </div>
                
                <!-- Appearance Settings -->
                <div class="settings-section">
                    <h3 class="settings-section-title">üé® Aussehen</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">üåô Dark Mode</label>
                            <p class="setting-description">Wechsle zwischen hellem und dunklem Design</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="darkModeToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- System Settings -->
                <div class="settings-section">
                    <h3 class="settings-section-title">‚öôÔ∏è System</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">üîÑ Auto-Sync</label>
                            <p class="setting-description">Automatische Synchronisation mit der Cloud</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoSyncToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">üîî Benachrichtigungen</label>
                            <p class="setting-description">Browser-Benachrichtigungen f√ºr Erinnerungen</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="notificationsToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Data Settings -->
                <div class="settings-section">
                    <h3 class="settings-section-title">üíæ Daten</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">üì§ Daten exportieren</label>
                            <p class="setting-description">Exportiere alle deine Daten als JSON</p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-secondary" id="exportDataBtn">Exportieren</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">üóëÔ∏è Cache leeren</label>
                            <p class="setting-description">L√∂sche lokale Zwischenspeicher</p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-secondary" id="clearCacheBtn">Cache leeren</button>
                        </div>
                    </div>
                    
                </div>
                
            </section>
        </div>

        <!-- === üîß RESTORE TAB === -->
        <div class="tab-content" id="restore">
            <section class="card">
                <div class="card-header">
                    <h2>üîß Routine Restore</h2>
                    <p>Repair your routine system and restore streak data</p>
                </div>
                
                <div class="settings-section">
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">1Ô∏è‚É£ Check Current Data</label>
                            <p class="setting-description">See what routine data is currently stored</p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-secondary" onclick="checkCurrentRoutineData()">Check Data</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">2Ô∏è‚É£ Set 5-Day Streaks</label>
                            <p class="setting-description">Set both routines to 5-day streaks for testing</p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-primary" onclick="setFiveDayStreaks()">Set Streaks</button>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <label class="setting-label">3Ô∏è‚É£ Cleanup</label>
                            <p class="setting-description">Remove old format data and duplicates</p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-secondary" onclick="cleanupRoutineData()">Cleanup</button>
                        </div>
                    </div>
                </div>
                
                <div id="restore-status" style="margin-top: 2rem;"></div>
            </section>
        </div>

    </div>

    <!-- Scripts -->
    <script src="supabase-config.js?v=4"></script>
    <script src="cloud-storage.js?v=4"></script>
    <script src="script.js?v=3"></script>
    
    <!-- HYBRID SYSTEM: Beautiful UI + Working Cloud Sync -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ HYBRID DASHBOARD - Beautiful UI + Cloud Sync');
            
            // Initialize navigation
            initializeNavigation();
            
            // Initialize Supabase
            const connected = initializeSupabase();
            
            if (connected && window.supabase) {
                console.log('‚úÖ Database connected - loading data...');
                await loadAndRenderTodos();
                await loadAndRenderGoals();
                await loadAndRenderJournal();
                await loadAndRenderRoutines();
                setupTodoButtons();
                setupGoalButtons();
                setupJournalButtons();
                setupRoutineToggles();
                await initializeStreaks();
                displayDailyQuote();
                initializeMotivationSlideshow();
                initializeSettings();
            } else {
                // Even without database, setup filter tabs
                setupFilterTabs();
                displayDailyQuote();
                initializeMotivationSlideshow();
                initializeSettings();
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.getAttribute('data-tab');
                    
                    // Remove active from all
                    navLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(t => t.classList.remove('active'));
                    
                    // Add active to clicked
                    link.classList.add('active');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                });
            });
        }
        
        async function loadAndRenderTodos() {
            try {
                const todos = await window.supabase.select('todos', '*', 'created_at.desc');
                console.log(`üìä Loaded ${todos?.length || 0} todos from cloud`);
                
                if (todos && todos.length > 0) {
                    renderTodos(todos);
                } else {
                    clearLoadingMessages();
                }
            } catch (error) {
                console.error('‚ùå Failed to load todos:', error);
            }
        }
        
        let currentFilter = 'alle';
        
        function renderTodos(todos) {
            const homeContainer = document.getElementById('home-todos');
            const activeContainer = document.getElementById('active-todos');
            
            // Clear containers
            if (homeContainer) homeContainer.innerHTML = '';
            if (activeContainer) activeContainer.innerHTML = '';
            
            const activeTodos = todos.filter(t => !t.completed);
            const completedTodos = todos.filter(t => t.completed);
            
            // Filter todos based on current filter and handle overdue logic
            let filteredActiveTodos, filteredCompletedTodos;
            
            // Process todos for overdue status and auto-categorization
            const processedTodos = processTodosForToday(activeTodos);
            
            if (currentFilter === 'alle') {
                filteredActiveTodos = processedTodos;
                filteredCompletedTodos = [];  // Don't show completed in 'alle' view
            } else if (currentFilter === 'archiv') {
                filteredActiveTodos = [];     // Don't show active in archive view
                filteredCompletedTodos = completedTodos;
            } else if (currentFilter === 'heute') {
                // Show today's todos AND overdue todos
                filteredActiveTodos = processedTodos.filter(t => t.category === 'heute');
                filteredCompletedTodos = [];
            } else {
                filteredActiveTodos = processedTodos.filter(t => t.category === currentFilter);
                filteredCompletedTodos = []; // Don't show completed in category views
            }
            
            // Render active todos (filtered)
            filteredActiveTodos.forEach(todo => {
                const categoryIcon = getCategoryIcon(todo.category);
                
                // Format due date/time if available
                let dueDateDisplay = '';
                if (todo.due_date) {
                    const dueDate = new Date(todo.due_date);
                    const today = new Date();
                    const isToday = dueDate.toDateString() === today.toDateString();
                    
                    if (todo.isOverdue) {
                        dueDateDisplay = `<small style="color: #dc3545; margin-left: 0.5rem; font-weight: bold;">‚ö†Ô∏è √úBERF√ÑLLIG ${dueDate.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}</small>`;
                    } else if (isToday) {
                        dueDateDisplay = `<small style="color: #17a2b8; margin-left: 0.5rem;">‚è∞ ${dueDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</small>`;
                    } else {
                        dueDateDisplay = `<small style="color: #666; margin-left: 0.5rem;">üìÖ ${dueDate.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}</small>`;
                    }
                }
                
                const todoHTML = `
                    <div class="checkbox-item" data-category="${todo.category}">
                        <input type="checkbox" data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                        <label>${categoryIcon} ${todo.text}${dueDateDisplay}</label>
                        <span class="todo-category" style="margin-left: auto; color: #666; font-size: 0.7rem; text-transform: uppercase;">${todo.category}</span>
                    </div>
                `;
                activeContainer.insertAdjacentHTML('beforeend', todoHTML);
            });
            
            // Render home todos (heute category only, including overdue)
            if (homeContainer) {
                const heuteTodos = processedTodos.filter(t => t.category === 'heute');
                heuteTodos.forEach(todo => {
                    const categoryIcon = getCategoryIcon(todo.category);
                    
                    // Format due time for home display
                    let dueDateDisplay = '';
                    if (todo.due_date) {
                        const dueDate = new Date(todo.due_date);
                        if (todo.isOverdue) {
                            dueDateDisplay = `<small style="color: #dc3545; margin-left: 0.5rem; font-weight: bold;">‚ö†Ô∏è √úBERF√ÑLLIG</small>`;
                        } else {
                            dueDateDisplay = `<small style="color: #17a2b8; margin-left: 0.5rem;">‚è∞ ${dueDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</small>`;
                        }
                    }
                    
                    const todoHTML = `
                        <div class="checkbox-item" data-category="${todo.category}" ${todo.isOverdue ? 'style="border-left: 3px solid #dc3545; padding-left: 0.5rem;"' : ''}>
                            <input type="checkbox" data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                            <label>${categoryIcon} ${todo.text}${dueDateDisplay}</label>
                        </div>
                    `;
                    homeContainer.insertAdjacentHTML('beforeend', todoHTML);
                });
            }
            
            // Render completed todos (only in archive view)
            if (activeContainer) {
                if (filteredCompletedTodos.length > 0) {
                    filteredCompletedTodos.forEach(todo => {
                        const categoryIcon = getCategoryIcon(todo.category);
                        const archivedHTML = `
                            <div class="checkbox-item" style="opacity: 0.7;" data-category="${todo.category}">
                                <input type="checkbox" checked disabled>
                                <label style="text-decoration: line-through; color: #999;">${categoryIcon} ${todo.text}</label>
                                <span style="margin-left: auto; color: #666; font-size: 0.8rem;">üìÅ</span>
                            </div>
                        `;
                        activeContainer.insertAdjacentHTML('beforeend', archivedHTML);
                    });
                } else if (currentFilter === 'archiv') {
                    // Show empty archive message
                    activeContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">üìÅ Archiv ist leer</div>';
                }
            }
            
            // Update section title
            const titleEl = document.getElementById('todos-section-title');
            if (titleEl) {
                if (currentFilter === 'alle') {
                    titleEl.textContent = 'Active Todos';
                } else if (currentFilter === 'archiv') {
                    titleEl.textContent = 'üìÅ Archived Todos';
                } else {
                    titleEl.textContent = `${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} Todos`;
                }
            }
            
            console.log(`‚úÖ Rendered ${filteredActiveTodos.length} active, ${filteredCompletedTodos.length} completed (${currentFilter})`);
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'heute': 'üìÖ',
                'privat': 'üè†',
                'uni': 'üéì',
                'arbeit': 'üíº'
            };
            return icons[category] || 'üìù';
        }
        
        function processTodosForToday(todos) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            return todos.map(todo => {
                const processedTodo = { ...todo };
                
                // Check if todo has a due date and is overdue
                if (todo.due_date) {
                    const dueDate = new Date(todo.due_date);
                    dueDate.setHours(0, 0, 0, 0); // Start of due date
                    
                    // If due date is before today, mark as overdue and categorize as 'heute'
                    if (dueDate < today) {
                        processedTodo.isOverdue = true;
                        processedTodo.category = 'heute'; // Move overdue todos to 'heute' category
                    }
                }
                
                return processedTodo;
            });
        }
        
        function clearLoadingMessages() {
            document.querySelectorAll('.loading-placeholder').forEach(el => {
                el.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No todos yet - click + to add one!</div>';
            });
        }
        
        function setupFilterTabs() {
            console.log('üîß Setting up filter tabs...');
            
            // Create filter tabs dynamically
            const filterContainer = document.querySelector('.filter-tabs');
            if (!filterContainer) {
                console.log('‚ùå Filter container not found');
                return;
            }
            
            const filters = [
                { id: 'alle', label: 'Alle', icon: '' },
                { id: 'heute', label: 'Heute', icon: 'üìÖ' },
                { id: 'privat', label: 'Privat', icon: 'üè†' },
                { id: 'uni', label: 'Uni', icon: 'üéì' },
                { id: 'arbeit', label: 'Arbeit', icon: 'üíº' },
                { id: 'archiv', label: 'Archiv', icon: 'üìÅ' }
            ];
            
            // Clear and rebuild filter tabs
            filterContainer.innerHTML = '';
            
            filters.forEach(filter => {
                const button = document.createElement('button');
                button.className = 'filter-tab' + (filter.id === 'alle' ? ' active' : '');
                button.setAttribute('data-filter', filter.id);
                button.textContent = filter.icon ? `${filter.icon} ${filter.label}` : filter.label;
                button.style.cssText = filter.id === 'alle' 
                    ? 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #007bff; color: white; cursor: pointer; font-size: 0.8rem;'
                    : 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                
                button.addEventListener('click', () => {
                    console.log(`üîç Filter clicked: ${filter.id}`);
                    
                    // Update all tabs
                    document.querySelectorAll('.filter-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                    });
                    
                    // Activate clicked tab
                    button.classList.add('active');
                    button.style.cssText = 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #007bff; color: white; cursor: pointer; font-size: 0.8rem;';
                    
                    // Update filter
                    currentFilter = filter.id;
                    
                    // Re-render
                    if (window.supabase) {
                        loadAndRenderTodos();
                    }
                    
                    // Show/hide archive clear button
                    toggleArchiveClearButton();
                });
                
                filterContainer.appendChild(button);
            });
            
            console.log(`‚úÖ Created ${filters.length} filter tabs`);
            
            // Initial button state
            toggleArchiveClearButton();
        }
        
        function setupTodoButtons() {
            document.getElementById('add-todo-btn').addEventListener('click', addNewTodo);
            document.getElementById('add-todo-btn-2').addEventListener('click', addNewTodo);
            document.getElementById('clear-archive-btn').addEventListener('click', clearArchive);
            setupFilterTabs();
        }
        
        function toggleArchiveClearButton() {
            const clearBtn = document.getElementById('clear-archive-btn');
            if (clearBtn) {
                clearBtn.style.display = currentFilter === 'archiv' ? 'block' : 'none';
            }
        }
        
        async function clearArchive() {
            if (!confirm('Alle archivierten Todos permanent l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                return;
            }
            
            try {
                // Get all completed todos
                const allTodos = await window.supabase.select('todos');
                const completedTodos = allTodos?.filter(t => t.completed) || [];
                
                if (completedTodos.length === 0) {
                    alert('Kein Archiv zum Leeren vorhanden.');
                    return;
                }
                
                // Delete all completed todos
                for (const todo of completedTodos) {
                    await window.supabase.delete('todos', todo.id);
                }
                
                console.log(`üóëÔ∏è Cleared ${completedTodos.length} archived todos`);
                
                // Immediately clear the display to prevent old data showing
                const activeContainer = document.getElementById('active-todos');
                if (activeContainer) {
                    if (currentFilter === 'archiv') {
                        activeContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">üìÅ Archiv ist leer</div>';
                    } else {
                        // Clear any old content for other filters
                        activeContainer.innerHTML = '<div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">‚òÅÔ∏è Loading todos...</div>';
                    }
                }
                
                // Refresh display - force reload from database
                await loadAndRenderTodos();
                
                alert(`${completedTodos.length} archivierte Todos wurden gel√∂scht.`);
                
            } catch (error) {
                console.error('‚ùå Failed to clear archive:', error);
                alert('Fehler beim Leeren des Archivs!');
            }
        }
        
        function showAddTodoModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="todo-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üìù Neues Todo</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Text:</label>
                            <input type="text" id="todo-text-input" placeholder="Todo beschreibung..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Kategorie:</label>
                            <select id="todo-category-modal" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="privat">üè† Privat</option>
                                <option value="uni">üéì Uni</option>
                                <option value="arbeit">üíº Arbeit</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Datum (optional):</label>
                            <input type="date" id="todo-date-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Uhrzeit (optional):</label>
                            <input type="time" id="todo-time-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="closeTodoModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                            <button onclick="saveTodo()" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Apply dark mode if active
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                const modal = document.getElementById('todo-modal');
                modal.style.background = 'rgba(0,0,0,0.8)';
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.style.background = '#2d2d2d';
                    modalContent.style.color = '#e0e0e0';
                    modalContent.style.borderColor = '#404040';
                }
            }
            
            // Set default date to today and time to 20:00
            document.getElementById('todo-date-input').value = new Date().toISOString().split('T')[0];
            document.getElementById('todo-time-input').value = '20:00';
            
            // Focus on text input
            document.getElementById('todo-text-input').focus();
        }
        
        function closeTodoModal() {
            const modal = document.getElementById('todo-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveTodo() {
            const textInput = document.getElementById('todo-text-input');
            const categoryInput = document.getElementById('todo-category-modal');
            const dateInput = document.getElementById('todo-date-input');
            const timeInput = document.getElementById('todo-time-input');
            
            const todoText = textInput.value.trim();
            if (!todoText) {
                alert('Bitte Todo-Text eingeben!');
                textInput.focus();
                return;
            }
            
            let category = categoryInput.value;
            const date = dateInput.value;
            const time = timeInput.value;
            
            // Build due date/time if provided
            let dueDate = null;
            if (date) {
                if (time) {
                    dueDate = new Date(`${date}T${time}`).toISOString();
                } else {
                    dueDate = new Date(`${date}T12:00:00`).toISOString();
                }
                
                // Auto-set category to "heute" if date is today
                const today = new Date().toISOString().split('T')[0];
                if (date === today) {
                    category = 'heute';
                }
            }
            
            const newTodo = {
                id: 'todo_' + Date.now(),
                text: todoText,
                completed: false,
                category: category,
                due_date: dueDate,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('todos', newTodo);
                console.log(`‚úÖ Todo added to cloud (${category}):`, todoText);
                closeTodoModal();
                await loadAndRenderTodos(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to add todo:', error);
                alert('Fehler beim Speichern des Todos!');
            }
        }
        
        async function addNewTodo() {
            showAddTodoModal();
        }
        
        // === GOALS SYSTEM ===
        async function loadAndRenderGoals() {
            try {
                const goals = await window.supabase.select('goals');
                console.log(`üìä Loaded ${goals?.length || 0} goals from cloud`);
                
                if (goals && goals.length > 0) {
                    renderGoals(goals);
                } else {
                    clearGoalLoadingMessages();
                }
            } catch (error) {
                console.error('‚ùå Failed to load goals:', error);
            }
        }
        
        function getCategoryIconGoal(category) {
            const icons = {
                'personal': 'üå±',
                'career': 'üíº',
                'health': 'üí™',
                'finance': 'üí∞',
                'education': 'üìö',
                'other': 'üéØ'
            };
            return icons[category] || 'üéØ';
        }
        
        function renderGoals(goals) {
            const activeContainer = document.getElementById('active-goals');
            
            // Clear container
            if (activeContainer) activeContainer.innerHTML = '';
            
            const activeGoals = goals.filter(g => !g.completed);
            const completedGoals = goals.filter(g => g.completed);
            
            // Filter goals based on current filter
            let filteredGoals;
            if (currentGoalFilter === 'active') {
                filteredGoals = activeGoals;
            } else if (currentGoalFilter === 'completed') {
                filteredGoals = completedGoals;
            }
            
            // Render filtered goals
            if (activeContainer) {
                if (filteredGoals.length > 0) {
                    filteredGoals.forEach(goal => {
                        const categoryIcon = getCategoryIconGoal(goal.category);
                        
                        if (currentGoalFilter === 'active') {
                            // Format target date for active goals
                            let targetDateDisplay = '';
                            if (goal.target_date) {
                                const targetDate = new Date(goal.target_date);
                                const today = new Date();
                                const isOverdue = targetDate < today;
                                
                                if (isOverdue) {
                                    targetDateDisplay = `<div style="color: #dc3545; font-size: 0.8rem; margin-top: 0.5rem;">‚ö†Ô∏è √úberf√§llig: ${targetDate.toLocaleDateString('de-DE')}</div>`;
                                } else {
                                    targetDateDisplay = `<div style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">üéØ Ziel: ${targetDate.toLocaleDateString('de-DE')}</div>`;
                                }
                            }
                            
                            const goalHTML = `
                                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                        <input type="checkbox" data-cloud-id="${goal.id}" onchange="syncGoalChange('${goal.id}', this.checked)" style="margin-top: 0.2rem;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.2rem;">${categoryIcon}</span>
                                                <h4 style="margin: 0; color: #333; font-size: 1rem;">${goal.title}</h4>
                                            </div>
                                            ${goal.description ? `<p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.4;">${goal.description}</p>` : ''}
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                                <span style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase;">${goal.category}</span>
                                                ${targetDateDisplay}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            activeContainer.insertAdjacentHTML('beforeend', goalHTML);
                        } else {
                            // Render completed goal
                            const completedHTML = `
                                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa; opacity: 0.7;">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                        <input type="checkbox" checked disabled style="margin-top: 0.2rem;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.2rem;">üèÜ</span>
                                                <h4 style="margin: 0; color: #666; font-size: 1rem; text-decoration: line-through;">${goal.title}</h4>
                                            </div>
                                            ${goal.description ? `<p style="margin: 0.5rem 0; color: #999; font-size: 0.9rem; text-decoration: line-through;">${goal.description}</p>` : ''}
                                            <span style="background: #6c757d; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">ERREICHT ‚úÖ</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            activeContainer.insertAdjacentHTML('beforeend', completedHTML);
                        }
                    });
                } else {
                    // Show empty message
                    const emptyMessage = currentGoalFilter === 'active' 
                        ? 'Keine aktiven Ziele - klicke + um eins hinzuzuf√ºgen!'
                        : 'üèÜ Keine erreichten Ziele vorhanden';
                    activeContainer.innerHTML = `<div style="text-align: center; color: #666; padding: 1rem;">${emptyMessage}</div>`;
                }
            }
            
            // Update section title
            const titleEl = document.getElementById('goals-section-title');
            if (titleEl) {
                titleEl.textContent = currentGoalFilter === 'active' ? 'üéØ Active Goals' : 'üèÜ Erreichte Ziele';
            }
            
            console.log(`‚úÖ Rendered ${filteredGoals?.length || 0} goals (${currentGoalFilter})`);
        }
        
        function clearGoalLoadingMessages() {
            const activeContainer = document.getElementById('active-goals');
            if (activeContainer) {
                activeContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No goals yet - click + to add one!</div>';
            }
        }
        
        function setupGoalButtons() {
            document.getElementById('add-goal-btn').addEventListener('click', addNewGoal);
            setupGoalFilterTabs();
        }
        
        let currentGoalFilter = 'active';
        
        function setupGoalFilterTabs() {
            console.log('üîß Setting up goal filter tabs...');
            
            // Create filter tabs dynamically
            const filterContainer = document.querySelector('.goal-filter-tabs');
            if (!filterContainer) {
                console.log('‚ùå Goal filter container not found');
                return;
            }
            
            const goalFilters = [
                { id: 'active', label: 'Aktiv', icon: 'üéØ' },
                { id: 'completed', label: 'Erreicht', icon: 'üèÜ' }
            ];
            
            // Clear and rebuild filter tabs
            filterContainer.innerHTML = '';
            
            goalFilters.forEach(filter => {
                const button = document.createElement('button');
                button.className = 'goal-filter-tab' + (filter.id === 'active' ? ' active' : '');
                button.setAttribute('data-filter', filter.id);
                button.textContent = `${filter.icon} ${filter.label}`;
                button.style.cssText = filter.id === 'active' 
                    ? 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #28a745; color: white; cursor: pointer; font-size: 0.8rem;'
                    : 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                
                button.addEventListener('click', () => {
                    console.log(`üîç Goal filter clicked: ${filter.id}`);
                    
                    // Update all tabs
                    document.querySelectorAll('.goal-filter-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                    });
                    
                    // Activate clicked tab
                    button.classList.add('active');
                    button.style.cssText = 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #28a745; color: white; cursor: pointer; font-size: 0.8rem;';
                    
                    // Update filter
                    currentGoalFilter = filter.id;
                    
                    // Re-render
                    if (window.supabase) {
                        loadAndRenderGoals();
                    }
                });
                
                filterContainer.appendChild(button);
            });
            
            console.log(`‚úÖ Created ${goalFilters.length} goal filter tabs`);
        }
        
        function showAddGoalModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="goal-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üéØ Neues Ziel</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Titel:</label>
                            <input type="text" id="goal-title-input" placeholder="Ziel-Titel..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Beschreibung (optional):</label>
                            <textarea id="goal-description-input" placeholder="Detaillierte Beschreibung..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Kategorie:</label>
                            <select id="goal-category-modal" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="personal">üå± Pers√∂nlich</option>
                                <option value="career">üíº Karriere</option>
                                <option value="health">üí™ Gesundheit</option>
                                <option value="finance">üí∞ Finanzen</option>
                                <option value="education">üìö Bildung</option>
                                <option value="other">üéØ Sonstiges</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Ziel-Datum (optional):</label>
                            <input type="date" id="goal-target-date-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="closeGoalModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                            <button onclick="saveGoal()" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Apply dark mode if active
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                const modal = document.getElementById('goal-modal');
                modal.style.background = 'rgba(0,0,0,0.8)';
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.style.background = '#2d2d2d';
                    modalContent.style.color = '#e0e0e0';
                    modalContent.style.borderColor = '#404040';
                }
            }
            
            // Focus on title input
            document.getElementById('goal-title-input').focus();
        }
        
        function closeGoalModal() {
            const modal = document.getElementById('goal-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveGoal() {
            const titleInput = document.getElementById('goal-title-input');
            const descriptionInput = document.getElementById('goal-description-input');
            const categoryInput = document.getElementById('goal-category-modal');
            const targetDateInput = document.getElementById('goal-target-date-input');
            
            const goalTitle = titleInput.value.trim();
            if (!goalTitle) {
                alert('Bitte Ziel-Titel eingeben!');
                titleInput.focus();
                return;
            }
            
            const description = descriptionInput.value.trim();
            const category = categoryInput.value;
            const targetDate = targetDateInput.value;
            
            const newGoal = {
                id: 'goal_' + Date.now(),
                title: goalTitle,
                description: description,
                category: category,
                target_date: targetDate ? new Date(targetDate).toISOString() : null,
                completed: false,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('goals', newGoal);
                console.log(`‚úÖ Goal added to cloud: ${goalTitle}`);
                closeGoalModal();
                await loadAndRenderGoals(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to add goal:', error);
                alert('Fehler beim Speichern des Ziels!');
            }
        }
        
        async function addNewGoal() {
            showAddGoalModal();
        }
        
        async function syncGoalChange(goalId, checked) {
            try {
                await window.supabase.update('goals', { completed: checked }, goalId);
                console.log(`‚òÅÔ∏è Goal synced: ${goalId} = ${checked}`);
                
                // Refresh display
                setTimeout(async () => {
                    await loadAndRenderGoals();
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Goal sync failed:', error);
            }
        }
        
        // === JOURNAL SYSTEM ===
        async function loadAndRenderJournal() {
            try {
                const entries = await window.supabase.select('journal_entries', '*', 'created_at.desc');
                console.log(`üìä Loaded ${entries?.length || 0} journal entries from cloud`);
                
                if (entries && entries.length > 0) {
                    renderJournalEntries(entries);
                } else {
                    clearJournalLoadingMessages();
                }
            } catch (error) {
                console.error('‚ùå Failed to load journal entries:', error);
            }
        }
        
        function getCategoryIconJournal(category) {
            const icons = {
                'general': 'üìù',
                'private': 'üè†', 
                'work': 'üíº',
                'health': 'üíö',
                'nutrition': 'ü•ó',
                'sport': 'üí™',
                'crypto': '‚Çø',
                'reading': 'üìö'
            };
            return icons[category] || 'üìù';
        }
        
        function renderJournalEntries(entries) {
            const container = document.getElementById('journal-entries');
            container.innerHTML = '';
            
            // Filter entries based on current filter
            let filteredEntries;
            if (currentJournalFilter === 'alle') {
                filteredEntries = entries;
            } else {
                filteredEntries = entries.filter(entry => entry.category === currentJournalFilter);
            }
            
            // Update section title
            const titleEl = document.getElementById('journal-section-title');
            if (titleEl) {
                const filterLabels = {
                    'alle': 'Daily Journal',
                    'general': 'Allgemein Journal',
                    'private': 'Privat Journal', 
                    'work': 'Arbeit Journal',
                    'health': 'Gesundheit Journal',
                    'nutrition': 'Ern√§hrung Journal',
                    'sport': 'Sport Journal',
                    'crypto': 'Crypto Journal',
                    'reading': 'Lese Journal'
                };
                titleEl.textContent = `üìî ${filterLabels[currentJournalFilter] || 'Journal'}`;
            }
            
            if (filteredEntries.length === 0) {
                const emptyMessage = currentJournalFilter === 'alle' 
                    ? 'Keine Journal-Eintr√§ge vorhanden - klicke + um einen hinzuzuf√ºgen!'
                    : `Keine ${currentJournalFilter} Eintr√§ge vorhanden`;
                container.innerHTML = `<div style="text-align: center; color: #666; padding: 2rem;">${emptyMessage}</div>`;
                return;
            }
            
            filteredEntries.forEach(entry => {
                const date = new Date(entry.created_at);
                const dateString = date.toLocaleDateString('de-DE', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const timeString = date.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Parse tags if they exist
                let tagsDisplay = '';
                if (entry.tags) {
                    const tagList = entry.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                    if (tagList.length > 0) {
                        tagsDisplay = `
                            <div style="margin-top: 0.5rem;">
                                ${tagList.map(tag => `<span style="background: #e9ecef; color: #495057; padding: 0.2rem 0.4rem; border-radius: 8px; font-size: 0.7rem; margin-right: 0.3rem;">#${tag}</span>`).join('')}
                            </div>
                        `;
                    }
                }
                
                const categoryIcon = getCategoryIconJournal(entry.category || 'general');
                
                const entryHTML = `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #17a2b8; font-size: 1.1rem;">${categoryIcon} ${entry.title || 'Journal Entry'}</h4>
                                <small style="color: #666; font-size: 0.8rem;">${dateString} um ${timeString}</small>
                            </div>
                            <button onclick="deleteJournalEntry('${entry.id}')" style="padding: 0.3rem 0.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">üóëÔ∏è</button>
                        </div>
                        
                        <div style="white-space: pre-wrap; color: #333; line-height: 1.6; margin-bottom: 1rem; font-size: 0.95rem;">${entry.content}</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${entry.mood ? `<span style="background: #fff3cd; color: #856404; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; border: 1px solid #ffeaa7;">${entry.mood}</span>` : ''}
                                ${entry.category ? `<span style="background: #17a2b8; color: white; padding: 0.2rem 0.5rem; border-radius: 8px; font-size: 0.7rem; text-transform: uppercase;">${entry.category}</span>` : ''}
                            </div>
                            ${tagsDisplay}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', entryHTML);
            });
            
            console.log(`‚úÖ Rendered ${filteredEntries.length} journal entries (${currentJournalFilter})`);
        }
        
        function clearJournalLoadingMessages() {
            const container = document.getElementById('journal-entries');
            if (container) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No journal entries yet - click + to add one!</div>';
            }
        }
        
        function setupJournalButtons() {
            document.getElementById('add-journal-btn').addEventListener('click', addNewJournalEntry);
            setupJournalFilterTabs();
        }
        
        let currentJournalFilter = 'alle';
        
        function setupJournalFilterTabs() {
            console.log('üîß Setting up journal filter tabs...');
            
            // Create filter tabs dynamically
            const filterContainer = document.querySelector('.journal-filter-tabs');
            if (!filterContainer) {
                console.log('‚ùå Journal filter container not found');
                return;
            }
            
            const journalFilters = [
                { id: 'alle', label: 'Alle', icon: 'üìî' },
                { id: 'general', label: 'Allgemein', icon: 'üìù' },
                { id: 'private', label: 'Privat', icon: 'üè†' },
                { id: 'work', label: 'Arbeit', icon: 'üíº' },
                { id: 'health', label: 'Gesundheit', icon: 'üíö' },
                { id: 'nutrition', label: 'Ern√§hrung', icon: 'ü•ó' },
                { id: 'sport', label: 'Sport', icon: 'üí™' },
                { id: 'crypto', label: 'Crypto', icon: '‚Çø' },
                { id: 'reading', label: 'Lesen', icon: 'üìö' }
            ];
            
            // Clear and rebuild filter tabs
            filterContainer.innerHTML = '';
            
            journalFilters.forEach(filter => {
                const button = document.createElement('button');
                button.className = 'journal-filter-tab' + (filter.id === 'alle' ? ' active' : '');
                button.setAttribute('data-filter', filter.id);
                button.textContent = `${filter.icon} ${filter.label}`;
                button.style.cssText = filter.id === 'alle' 
                    ? 'padding: 0.4rem 0.8rem; border: none; border-radius: 15px; background: #17a2b8; color: white; cursor: pointer; font-size: 0.75rem; margin-bottom: 0.3rem;'
                    : 'padding: 0.4rem 0.8rem; border: 1px solid #ddd; border-radius: 15px; background: white; color: #666; cursor: pointer; font-size: 0.75rem; margin-bottom: 0.3rem;';
                
                button.addEventListener('click', () => {
                    console.log(`üîç Journal filter clicked: ${filter.id}`);
                    
                    // Update all tabs
                    document.querySelectorAll('.journal-filter-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.cssText = 'padding: 0.4rem 0.8rem; border: 1px solid #ddd; border-radius: 15px; background: white; color: #666; cursor: pointer; font-size: 0.75rem; margin-bottom: 0.3rem;';
                    });
                    
                    // Activate clicked tab
                    button.classList.add('active');
                    button.style.cssText = 'padding: 0.4rem 0.8rem; border: none; border-radius: 15px; background: #17a2b8; color: white; cursor: pointer; font-size: 0.75rem; margin-bottom: 0.3rem;';
                    
                    // Update filter
                    currentJournalFilter = filter.id;
                    
                    // Re-render
                    if (window.supabase) {
                        loadAndRenderJournal();
                    }
                });
                
                filterContainer.appendChild(button);
            });
            
            console.log(`‚úÖ Created ${journalFilters.length} journal filter tabs`);
        }
        
        function showAddJournalModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="journal-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üìî Neuer Journal-Eintrag</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Titel (optional):</label>
                            <input type="text" id="journal-title-input" placeholder="z.B. Mein Tag, Gedanken, Reflexion..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Inhalt:</label>
                            <textarea id="journal-content-input" placeholder="Schreibe deine Gedanken, Erlebnisse, Reflexionen..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; min-height: 120px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Stimmung (optional):</label>
                            <select id="journal-mood-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="">-- Stimmung w√§hlen --</option>
                                <option value="üòä Sehr gut">üòä Sehr gut</option>
                                <option value="üôÇ Gut">üôÇ Gut</option>
                                <option value="üòê Neutral">üòê Neutral</option>
                                <option value="üòî Schlecht">üòî Schlecht</option>
                                <option value="üò¢ Sehr schlecht">üò¢ Sehr schlecht</option>
                                <option value="üò§ Gestresst">üò§ Gestresst</option>
                                <option value="üò¥ M√ºde">üò¥ M√ºde</option>
                                <option value="üí™ Motiviert">üí™ Motiviert</option>
                                <option value="ü§î Nachdenklich">ü§î Nachdenklich</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Kategorie:</label>
                            <select id="journal-category-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="general">üìù Allgemein</option>
                                <option value="private">üè† Privat</option>
                                <option value="work">üíº Arbeit</option>
                                <option value="health">üíö Gesundheit</option>
                                <option value="nutrition">ü•ó Ern√§hrung</option>
                                <option value="sport">üí™ Sport</option>
                                <option value="crypto">‚Çø Crypto</option>
                                <option value="reading">üìö Lesen</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Tags (optional):</label>
                            <input type="text" id="journal-tags-input" placeholder="z.B. thoughts, reflection, goals (durch Komma getrennt)" autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="closeJournalModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                            <button onclick="saveJournalEntry()" style="padding: 0.5rem 1rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Apply dark mode if active
            if (document.documentElement.getAttribute('data-theme') === 'dark') {
                const modal = document.getElementById('journal-modal');
                modal.style.background = 'rgba(0,0,0,0.8)';
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.style.background = '#2d2d2d';
                    modalContent.style.color = '#e0e0e0';
                    modalContent.style.borderColor = '#404040';
                }
            }
            
            // Set default title to today's date
            const today = new Date().toLocaleDateString('de-DE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('journal-title-input').value = `${today}`;
            
            // Focus on content input
            document.getElementById('journal-content-input').focus();
        }
        
        function closeJournalModal() {
            const modal = document.getElementById('journal-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveJournalEntry() {
            const titleInput = document.getElementById('journal-title-input');
            const contentInput = document.getElementById('journal-content-input');
            const moodInput = document.getElementById('journal-mood-input');
            const categoryInput = document.getElementById('journal-category-input');
            const tagsInput = document.getElementById('journal-tags-input');
            
            const content = contentInput.value.trim();
            if (!content) {
                alert('Bitte Journal-Inhalt eingeben!');
                contentInput.focus();
                return;
            }
            
            const title = titleInput.value.trim() || `Entry ${new Date().toLocaleDateString('de-DE')}`;
            const mood = moodInput.value;
            const category = categoryInput.value;
            const tags = tagsInput.value.trim();
            
            const newEntry = {
                id: 'journal_' + Date.now(),
                title: title,
                content: content,
                mood: mood,
                category: category,
                tags: tags,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('journal_entries', newEntry);
                console.log(`‚úÖ Journal entry added (${category}): ${title}`);
                closeJournalModal();
                await loadAndRenderJournal(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to add journal entry:', error);
                alert('Fehler beim Speichern des Journal-Eintrags!');
            }
        }
        
        async function addNewJournalEntry() {
            showAddJournalModal();
        }
        
        async function deleteJournalEntry(entryId) {
            if (!confirm('Delete this journal entry?')) return;
            
            try {
                await window.supabase.delete('journal_entries', entryId);
                console.log(`üóëÔ∏è Journal entry deleted: ${entryId}`);
                await loadAndRenderJournal(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to delete journal entry:', error);
            }
        }
        
        async function syncTodoChange(todoId, checked) {
            try {
                await window.supabase.update('todos', { completed: checked }, todoId);
                console.log(`‚òÅÔ∏è Todo synced: ${todoId} = ${checked}`);
                
                // Refresh display
                setTimeout(async () => {
                    await loadAndRenderTodos();
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
            }
        }
        
        // === ROUTINES SYSTEM ===
        let currentRoutineType = 'morning';
        
        async function loadAndRenderRoutines() {
            try {
                console.log('üìã Loading routine system...');
                await loadRoutineTemplates();
                console.log('‚úÖ Routine system loaded');
            } catch (error) {
                console.error('‚ùå Failed to load routines:', error);
                // Fallback to local templates
                await loadRoutineTemplates();
            }
        }
        
        async function renderCurrentRoutine(routineType) {
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Get templates for this routine type
                const templates = await window.supabase.query(
                    `routine_templates?routine_type=eq.${routineType}&active=eq.true&order=order_index`
                );
                
                if (!templates || templates.length === 0) {
                    document.getElementById('current-routine').innerHTML = 
                        `<div style="text-align: center; color: #666; padding: 1rem;">No ${routineType} routine configured</div>`;
                    return;
                }
                
                // Get today's completions for these templates
                const completions = await window.supabase.query(
                    `routine_completions?date=eq.${today}`
                );
                
                const completionMap = {};
                if (completions) {
                    completions.forEach(comp => {
                        completionMap[comp.template_id] = comp.completed;
                    });
                }
                
                // Render routine items
                const routineContainer = document.getElementById('current-routine');
                routineContainer.innerHTML = '';
                
                templates.forEach(template => {
                    const isCompleted = completionMap[template.id] || false;
                    const routineHTML = `
                        <div class="checkbox-item">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   data-template-id="${template.id}" data-routine-type="${routineType}"
                                   onchange="syncRoutineChange('${template.id}', this.checked)">
                            <label style="${isCompleted ? 'text-decoration: line-through; color: #999;' : ''}">${template.text}</label>
                        </div>
                    `;
                    routineContainer.insertAdjacentHTML('beforeend', routineHTML);
                });
                
                console.log(`‚úÖ Rendered ${templates.length} ${routineType} routine items`);
                
            } catch (error) {
                console.error('‚ùå Failed to render routine:', error);
            }
        }
        
        async function syncRoutineChange(templateId, completed) {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Check if completion record exists
                const existing = await window.supabase.query(
                    `routine_completions?template_id=eq.${templateId}&date=eq.${today}`
                );
                
                if (existing && existing.length > 0) {
                    // Update existing
                    await window.supabase.update('routine_completions', 
                        { completed: completed }, 
                        existing[0].id
                    );
                } else {
                    // Create new completion record
                    const newCompletion = {
                        id: `completion_${templateId}_${today}`,
                        template_id: templateId,
                        date: today,
                        completed: completed
                    };
                    await window.supabase.insert('routine_completions', newCompletion);
                }
                
                console.log(`‚òÅÔ∏è Routine synced: ${templateId} = ${completed}`);
                
                // Update UI
                const checkbox = document.querySelector(`[data-template-id="${templateId}"]`);
                if (checkbox) {
                    const label = checkbox.nextElementSibling;
                    if (label) {
                        label.style.textDecoration = completed ? 'line-through' : '';
                        label.style.color = completed ? '#999' : '';
                    }
                }
                
                // Update streak counters instantly (optimistic UI)
                updateStreakInstantly(templateId, completed);
                
                // Also do full recalculation in background
                setTimeout(() => updateRoutineStreaks(), 200);
                
            } catch (error) {
                console.error('‚ùå Routine sync failed:', error);
            }
        }
        
        function setupRoutineToggles() {
            const morningToggle = document.querySelector('[data-routine="morning"]');
            const eveningToggle = document.querySelector('[data-routine="evening"]');
            
            morningToggle?.addEventListener('click', async () => {
                currentRoutineType = 'morning';
                
                // Update toggle states
                morningToggle.classList.add('active');
                eveningToggle?.classList.remove('active');
                
                await switchRoutineType('morning');
            });
            
            eveningToggle?.addEventListener('click', async () => {
                currentRoutineType = 'evening';
                
                // Update toggle states
                eveningToggle.classList.add('active');
                morningToggle?.classList.remove('active');
                
                await switchRoutineType('evening');
            });
        }
        
        async function updateRoutineStreaks() {
            try {
                console.log('üìä Calculating routine streaks...');
                
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                                   'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                
                // Calculate morning routine streak for current month
                const morningStreak = await calculateMonthlyRoutineStreak('morning', currentYear, currentMonth);
                const eveningStreak = await calculateMonthlyRoutineStreak('evening', currentYear, currentMonth);
                
                // Update UI
                document.getElementById('morningRoutineStreakCount').textContent = morningStreak;
                document.getElementById('morningRoutineStreakDate').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                document.getElementById('eveningRoutineStreakCount').textContent = eveningStreak;
                document.getElementById('eveningRoutineStreakDate').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                console.log(`‚úÖ Updated streaks: Morning ${morningStreak}, Evening ${eveningStreak}`);
                
            } catch (error) {
                console.error('‚ùå Failed to update streaks:', error);
            }
        }
        
        async function calculateMonthlyRoutineStreak(routineType, year, month) {
            try {
                // Get first and last day of month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const today = new Date();
                
                // Only count up to today if we're in current month
                const endDate = (year === today.getFullYear() && month === today.getMonth()) 
                    ? today : lastDay;
                
                let completedDays = 0;
                
                // Check each day in the month (up to today)
                for (let day = 1; day <= endDate.getDate(); day++) {
                    const checkDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    // Get all templates for this routine type
                    const templates = await window.supabase.query(
                        `routine_templates?routine_type=eq.${routineType}&active=eq.true`
                    );
                    
                    if (!templates || templates.length === 0) continue;
                    
                    // Get completions for this day
                    const completions = await window.supabase.query(
                        `routine_completions?date=eq.${checkDate}`
                    );
                    
                    // Check if ALL routine items for this type were completed
                    let allCompleted = true;
                    for (const template of templates) {
                        const completion = completions?.find(c => c.template_id === template.id);
                        if (!completion || !completion.completed) {
                            allCompleted = false;
                            break;
                        }
                    }
                    
                    if (allCompleted) {
                        completedDays++;
                    }
                }
                
                return completedDays;
                
            } catch (error) {
                console.error(`‚ùå Failed to calculate ${routineType} streak:`, error);
                return 0;
            }
        }
        
        // Initialize streaks on page load
        async function initializeStreaks() {
            console.log('üî• Initializing streaks...');
            // Use the new streak system from script.js
            if (typeof updateMonthlyRoutineStreak === 'function') {
                updateMonthlyRoutineStreak('morning');
                updateMonthlyRoutineStreak('evening');
            } else {
                // Fallback
                console.log('‚ö†Ô∏è updateMonthlyRoutineStreak not found, using fallback');
                await updateRoutineStreaks();
            }
        }
        
        // === QUOTES SYSTEM ===
        const motivationalQuotes = [
            { text: "Der einzige Weg, gro√üartige Arbeit zu leisten, ist zu lieben, was du tust.", author: "Steve Jobs" },
            { text: "Das Leben ist das, was passiert, w√§hrend du eifrig dabei bist, andere Pl√§ne zu machen.", author: "John Lennon" },
            { text: "Die Zukunft geh√∂rt denen, die an die Sch√∂nheit ihrer Tr√§ume glauben.", author: "Eleanor Roosevelt" },
            { text: "Es ist nicht wichtig, wie langsam du gehst, solange du nicht stehen bleibst.", author: "Konfuzius" },
            { text: "Der beste Zeitpunkt, einen Baum zu pflanzen, war vor 20 Jahren. Der zweitbeste ist jetzt.", author: "Chinesisches Sprichwort" },
            { text: "Erfolg ist nicht endg√ºltig, Misserfolg ist nicht t√∂dlich: Was z√§hlt, ist der Mut weiterzumachen.", author: "Winston Churchill" },
            { text: "Das einzige Unm√∂gliche ist das, was du nicht versuchst.", author: "Tommy Lasorda" },
            { text: "Du bist nie zu alt, um dir ein weiteres Ziel zu setzen oder einen neuen Traum zu tr√§umen.", author: "C.S. Lewis" },
            { text: "Der Unterschied zwischen dem Unm√∂glichen und dem M√∂glichen liegt in der Entschlossenheit einer Person.", author: "Tommy Lasorda" },
            { text: "Glaube an dich selbst und alles ist m√∂glich.", author: "Unbekannt" },
            { text: "Die gr√∂√üte Belohnung f√ºr harte Arbeit ist nicht das, was man daf√ºr bekommt, sondern das, was man dadurch wird.", author: "John Ruskin" },
            { text: "Tr√§ume nicht dein Leben, sondern lebe deine Tr√§ume.", author: "Mark Twain" },
            { text: "Was uns nicht umbringt, macht uns st√§rker.", author: "Friedrich Nietzsche" },
            { text: "Der Weg zum Erfolg ist, dass man seine Berufung zu seinem Beruf macht.", author: "Mark Twain" },
            { text: "Wer k√§mpft, kann verlieren. Wer nicht k√§mpft, hat schon verloren.", author: "Bertolt Brecht" },
            { text: "Das Geheimnis des Vorankommens besteht darin, den ersten Schritt zu tun.", author: "Mark Twain" },
            { text: "Erfolg ist die Summe kleiner Anstrengungen, die t√§glich wiederholt werden.", author: "Robert Collier" },
            { text: "Du kannst die Wellen nicht stoppen, aber du kannst lernen zu surfen.", author: "Jon Kabat-Zinn" },
            { text: "Das Leben beginnt dort, wo deine Komfortzone endet.", author: "Neale Donald Walsch" },
            { text: "Jeder Tag ist eine neue Chance, das zu tun, was du m√∂chtest.", author: "Friedrich von Schiller" }
        ];
        
        function getDailyQuote() {
            // Use current date as seed for consistent daily quote
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const quoteIndex = dayOfYear % motivationalQuotes.length;
            return motivationalQuotes[quoteIndex];
        }
        
        function displayDailyQuote() {
            const quote = getDailyQuote();
            document.getElementById('dailyQuoteText').textContent = `"${quote.text}"`;
            document.getElementById('dailyQuoteAuthor').textContent = `‚Äî ${quote.author}`;
        }
        
        function getNewQuote() {
            // Random quote for manual refresh
            const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
            const quote = motivationalQuotes[randomIndex];
            
            // Animate quote change
            const textEl = document.getElementById('dailyQuoteText');
            const authorEl = document.getElementById('dailyQuoteAuthor');
            
            textEl.style.opacity = '0.3';
            authorEl.style.opacity = '0.3';
            
            setTimeout(() => {
                textEl.textContent = `"${quote.text}"`;
                authorEl.textContent = `‚Äî ${quote.author}`;
                textEl.style.opacity = '1';
                authorEl.style.opacity = '1';
            }, 200);
        }
        
        function updateStreakInstantly(templateId, completed) {
            // Get current streak values
            const morningStreakEl = document.getElementById('morningRoutineStreakCount');
            const eveningStreakEl = document.getElementById('eveningRoutineStreakCount');
            
            // Determine which routine type this template belongs to
            const checkbox = document.querySelector(`[data-template-id="${templateId}"]`);
            const routineType = checkbox?.getAttribute('data-routine-type');
            
            if (!routineType) return;
            
            // Check if all items of this routine type are now completed
            const allCheckboxes = document.querySelectorAll(`[data-routine-type="${routineType}"]`);
            let allCompleted = true;
            allCheckboxes.forEach(cb => {
                if (!cb.checked) allCompleted = false;
            });
            
            // Update streak counter instantly
            const streakEl = routineType === 'morning' ? morningStreakEl : eveningStreakEl;
            const currentStreak = parseInt(streakEl.textContent) || 0;
            
            if (completed && allCompleted) {
                // All items completed - increment streak
                streakEl.textContent = currentStreak + 1;
                console.log(`‚ö° Instant streak update: ${routineType} +1`);
            } else if (!completed && currentStreak > 0) {
                // Item unchecked - decrement streak  
                streakEl.textContent = Math.max(0, currentStreak - 1);
                console.log(`‚ö° Instant streak update: ${routineType} -1`);
            }
        }
        
        // === MOTIVATION SLIDESHOW SYSTEM ===
        let currentSlide = 0;
        let autoPlayInterval = null;
        let isAutoPlaying = true;
        
        function showSlide(slideIndex) {
            const slides = document.querySelectorAll('.motivational-slide');
            const indicators = document.querySelectorAll('.indicator');
            const slideCounter = document.getElementById('slideCounter');
            
            // Hide all slides
            slides.forEach(slide => {
                slide.style.display = 'none';
            });
            
            // Reset all indicators
            indicators.forEach(indicator => {
                indicator.style.background = '#ccc';
                indicator.style.opacity = '0.5';
            });
            
            // Show current slide
            if (slides[slideIndex]) {
                slides[slideIndex].style.display = 'flex';
            }
            
            // Highlight current indicator
            if (indicators[slideIndex]) {
                indicators[slideIndex].style.background = '#333';
                indicators[slideIndex].style.opacity = '1';
            }
            
            // Update counter
            if (slideCounter) {
                slideCounter.textContent = `${slideIndex + 1}/${slides.length}`;
            }
            
            currentSlide = slideIndex;
        }
        
        function nextSlide() {
            const slides = document.querySelectorAll('.motivational-slide');
            currentSlide = (currentSlide + 1) % slides.length;
            showSlide(currentSlide);
        }
        
        function prevSlide() {
            const slides = document.querySelectorAll('.motivational-slide');
            currentSlide = (currentSlide - 1 + slides.length) % slides.length;
            showSlide(currentSlide);
        }
        
        function toggleAutoPlay() {
            const autoPlayBtn = document.getElementById('autoPlayToggle');
            
            if (isAutoPlaying) {
                // Stop auto play
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval);
                    autoPlayInterval = null;
                }
                isAutoPlaying = false;
                autoPlayBtn.textContent = 'Play';
                autoPlayBtn.className = 'btn btn-small btn-transparent';
            } else {
                // Start auto play
                autoPlayInterval = setInterval(nextSlide, 4000); // 4 seconds
                isAutoPlaying = true;
                autoPlayBtn.textContent = 'Auto';
                autoPlayBtn.className = 'btn btn-small btn-dark';
            }
        }
        
        function initializeMotivationSlideshow() {
            // Show first slide
            showSlide(0);
            
            // Start auto play
            if (isAutoPlaying) {
                autoPlayInterval = setInterval(nextSlide, 4000);
            }
            
            // Add event listeners
            const nextBtn = document.getElementById('nextSlide');
            const prevBtn = document.getElementById('prevSlide');
            const autoPlayBtn = document.getElementById('autoPlayToggle');
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    nextSlide();
                    // Reset auto play timer
                    if (isAutoPlaying) {
                        clearInterval(autoPlayInterval);
                        autoPlayInterval = setInterval(nextSlide, 4000);
                    }
                });
            }
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    prevSlide();
                    // Reset auto play timer
                    if (isAutoPlaying) {
                        clearInterval(autoPlayInterval);
                        autoPlayInterval = setInterval(nextSlide, 4000);
                    }
                });
            }
            
            if (autoPlayBtn) {
                autoPlayBtn.addEventListener('click', toggleAutoPlay);
            }
            
            // Add click events to indicators
            const indicators = document.querySelectorAll('.indicator');
            indicators.forEach((indicator, index) => {
                indicator.addEventListener('click', () => {
                    showSlide(index);
                    // Reset auto play timer
                    if (isAutoPlaying) {
                        clearInterval(autoPlayInterval);
                        autoPlayInterval = setInterval(nextSlide, 4000);
                    }
                });
            });
            
            console.log('‚úÖ Motivational slideshow initialized');
        }
        
        // === SETTINGS SYSTEM ===
        function initializeSettings() {
            // Load saved preferences
            loadUserPreferences();
            
            // Setup event listeners
            setupSettingsEventListeners();
            
            console.log('‚úÖ Settings system initialized');
            
            // Add a test function accessible from console
            window.testDarkMode = function() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                applyTheme(!isDark);
                console.log('üß™ Test toggle completed');
            };
            
            console.log('üí° Type "testDarkMode()" in console to test dark mode toggle');
            console.log('üí° Type "fixWhiteBoxes()" in console to force fix white containers');
            
            // Add manual white box fixer
            window.fixWhiteBoxes = function() {
                console.log('üîß Manually fixing all white boxes...');
                if (document.documentElement.getAttribute('data-theme') === 'dark') {
                    // Find and fix ALL white backgrounds
                    document.querySelectorAll('*').forEach(element => {
                        const computedStyle = getComputedStyle(element);
                        if (computedStyle.backgroundColor === 'rgb(255, 255, 255)' || 
                            computedStyle.backgroundColor === 'white') {
                            element.style.setProperty('background-color', 'transparent', 'important');
                            element.style.setProperty('color', '#e0e0e0', 'important');
                            console.log('üéØ Fixed white element:', element);
                        }
                    });
                    
                    // Special focus on routine containers
                    const routineContainers = ['current-routine', 'home-todos', 'active-todos', 'active-goals', 'journal-entries'];
                    routineContainers.forEach(id => {
                        const container = document.getElementById(id);
                        if (container) {
                            container.querySelectorAll('*').forEach(el => {
                                el.style.setProperty('background-color', 'transparent', 'important');
                                el.style.setProperty('color', '#e0e0e0', 'important');
                            });
                        }
                    });
                    
                    console.log('‚úÖ White box fixing completed');
                } else {
                    console.log('‚ÑπÔ∏è Dark mode not active - activate first');
                }
            };
        }
        
        function loadUserPreferences() {
            // Load dark mode preference
            const darkMode = localStorage.getItem('dashfin-dark-mode') === 'true';
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.checked = darkMode;
                applyTheme(darkMode);
            }
            
            // Load auto-sync preference
            const autoSync = localStorage.getItem('dashfin-auto-sync') !== 'false'; // default true
            const autoSyncToggle = document.getElementById('autoSyncToggle');
            if (autoSyncToggle) {
                autoSyncToggle.checked = autoSync;
            }
            
            // Load notifications preference
            const notifications = localStorage.getItem('dashfin-notifications') === 'true';
            const notificationsToggle = document.getElementById('notificationsToggle');
            if (notificationsToggle) {
                notificationsToggle.checked = notifications;
            }
        }
        
        function setupSettingsEventListeners() {
            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', (e) => {
                    const isDark = e.target.checked;
                    applyTheme(isDark);
                    localStorage.setItem('dashfin-dark-mode', isDark.toString());
                    console.log(`üåô Dark mode: ${isDark ? 'enabled' : 'disabled'}`);
                });
            }
            
            // Auto-Sync Toggle
            const autoSyncToggle = document.getElementById('autoSyncToggle');
            if (autoSyncToggle) {
                autoSyncToggle.addEventListener('change', (e) => {
                    const autoSync = e.target.checked;
                    localStorage.setItem('dashfin-auto-sync', autoSync.toString());
                    console.log(`üîÑ Auto-sync: ${autoSync ? 'enabled' : 'disabled'}`);
                });
            }
            
            // Notifications Toggle
            const notificationsToggle = document.getElementById('notificationsToggle');
            if (notificationsToggle) {
                notificationsToggle.addEventListener('change', (e) => {
                    const notifications = e.target.checked;
                    localStorage.setItem('dashfin-notifications', notifications.toString());
                    
                    if (notifications) {
                        requestNotificationPermission();
                    }
                    console.log(`üîî Notifications: ${notifications ? 'enabled' : 'disabled'}`);
                });
            }
            
            // Export Data Button
            const exportBtn = document.getElementById('exportDataBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportUserData);
            }
            
            // Clear Cache Button
            const clearCacheBtn = document.getElementById('clearCacheBtn');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', clearLocalCache);
            }
        }
        
        function applyTheme(isDark) {
            console.log(`üé® Applying theme: ${isDark ? 'dark' : 'light'}`);
            
            // Remove existing dynamic style
            const existingStyle = document.getElementById('dynamic-theme-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.body.classList.add('dark-theme');
                
                // Inject dynamic dark mode CSS
                const darkModeCSS = `
                    <style id="dynamic-theme-style">
                        /* Base styles */
                        body { background-color: #1a1a1a !important; color: #e0e0e0 !important; }
                        .card { background: #2d2d2d !important; border-color: #404040 !important; color: #e0e0e0 !important; }
                        .sticky-nav { background: #2d2d2d !important; border-bottom-color: #404040 !important; }
                        
                        /* Navigation */
                        .nav-link { color: #e0e0e0 !important; }
                        .nav-link:hover { color: #ffffff !important; background: #404040 !important; }
                        .nav-link.active { background: #0056b3 !important; color: #ffffff !important; }
                        
                        /* Form elements */
                        input, textarea, select { background: #404040 !important; color: #e0e0e0 !important; border-color: #555555 !important; }
                        input::placeholder, textarea::placeholder { color: #b0b0b0 !important; }
                        
                        /* Text elements */
                        h1, h2, h3, h4, h5, h6 { color: #e0e0e0 !important; }
                        p, span, div, label { color: #e0e0e0 !important; }
                        
                        /* Buttons */
                        button { background: #404040 !important; color: #e0e0e0 !important; border-color: #555555 !important; }
                        button:hover { background: #555555 !important; }
                        .btn-primary { background: #0056b3 !important; color: #ffffff !important; }
                        .btn-success { background: #28a745 !important; color: #ffffff !important; }
                        .btn-info { background: #17a2b8 !important; color: #ffffff !important; }
                        .btn-danger { background: #dc3545 !important; color: #ffffff !important; }
                        
                        /* Checkboxes and todos */
                        .checkbox-item { border-bottom-color: #404040 !important; color: #e0e0e0 !important; }
                        .checkbox-item label { color: #e0e0e0 !important; }
                        .todo-category { color: #b0b0b0 !important; }
                        
                        /* Modals */
                        #todo-modal > div, #goal-modal > div, #journal-modal > div { 
                            background: #2d2d2d !important; color: #e0e0e0 !important; border-color: #404040 !important; 
                        }
                        
                        /* Filters and tabs */
                        .filter-tab, .goal-filter-tab, .journal-filter-tab { 
                            background: #404040 !important; color: #e0e0e0 !important; border-color: #555555 !important; 
                        }
                        .filter-tab.active, .goal-filter-tab.active, .journal-filter-tab.active { 
                            background: #007bff !important; color: #ffffff !important; 
                        }
                        .filter-tabs, .goal-filter-tabs, .journal-filter-tabs { 
                            border-bottom-color: #404040 !important; 
                        }
                        
                        /* Streak tiles */
                        .streak-tile { background: #404040 !important; border-color: #555555 !important; color: #e0e0e0 !important; }
                        .streak-number { color: #ffffff !important; }
                        .streak-label { color: #e0e0e0 !important; }
                        .streak-date { color: #b0b0b0 !important; }
                        
                        /* Quote section */
                        #dailyQuoteText { color: #e0e0e0 !important; }
                        #dailyQuoteAuthor { color: #b0b0b0 !important; }
                        
                        /* Slideshow */
                        .slideshow-container { background: #2d2d2d !important; border-color: #404040 !important; }
                        #slideCounter { color: #b0b0b0 !important; }
                        .indicator { background: #b0b0b0 !important; }
                        .indicator.active { background: #ffffff !important; }
                        
                        /* Settings */
                        .settings-section { background: #2d2d2d !important; border-color: #404040 !important; }
                        .settings-section-title { color: #e0e0e0 !important; border-bottom-color: #404040 !important; }
                        .setting-item { border-bottom-color: #404040 !important; }
                        .setting-label { color: #e0e0e0 !important; }
                        .setting-description { color: #b0b0b0 !important; }
                        
                        /* Toggle switch */
                        .toggle-slider { background: #555555 !important; }
                        input:checked + .toggle-slider { background: #0056b3 !important; }
                        
                        /* Goals and journal entries */
                        .goal-card, .journal-entry { background: #2d2d2d !important; border-color: #404040 !important; color: #e0e0e0 !important; }
                        
                        /* Dynamically generated content */
                        div[style*="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)"] { 
                            background: linear-gradient(135deg, #404040 0%, #555555 100%) !important; 
                        }
                        div[style*="background: #f8f9fa"] { background: #2d2d2d !important; }
                        div[style*="background: #ffffff"] { background: #2d2d2d !important; }
                        div[style*="background: white"] { background: #2d2d2d !important; }
                        div[style*="border: 1px solid #e0e0e0"] { border-color: #404040 !important; }
                        div[style*="color: #333"] { color: #e0e0e0 !important; }
                        div[style*="color: #666"] { color: #b0b0b0 !important; }
                        div[style*="color: #999"] { color: #b0b0b0 !important; }
                        div[style*="color: #17a2b8"] { color: #17a2b8 !important; }
                        
                        /* Routine boxes */
                        .checkbox-group { background: transparent !important; }
                        #current-routine { background: transparent !important; }
                        #current-routine > * { background: transparent !important; color: #e0e0e0 !important; }
                        #home-todos { background: transparent !important; }
                        #active-todos { background: transparent !important; }
                        #active-goals { background: transparent !important; }
                        #journal-entries { background: transparent !important; }
                        
                        /* Force all checkbox items and routine items to be dark */
                        .checkbox-item, .checkbox-item > *, [class*="routine"] { 
                            background: transparent !important; 
                            color: #e0e0e0 !important; 
                            border-color: #404040 !important;
                        }
                        
                        /* All divs with inline styles that could be white */
                        div[style*="padding: 1rem"] { color: #e0e0e0 !important; }
                        div[style*="padding: 1.5rem"] { color: #e0e0e0 !important; }
                        div[style*="padding: 2rem"] { color: #e0e0e0 !important; }
                        
                        /* Any element with box-shadow */
                        div[style*="box-shadow"] { 
                            background: #2d2d2d !important; 
                            color: #e0e0e0 !important; 
                            border-color: #404040 !important; 
                        }
                        
                        /* Loading placeholders */
                        .loading-placeholder { color: #b0b0b0 !important; }
                        
                        /* Specific inline styled elements */
                        div[style*="color: #666"], span[style*="color: #666"] { color: #b0b0b0 !important; }
                        div[style*="color: #6c757d"], span[style*="color: #6c757d"] { color: #b0b0b0 !important; }
                        div[style*="color: #495057"], span[style*="color: #495057"] { color: #e0e0e0 !important; }
                        div[style*="border-bottom: 1px solid #eee"] { border-bottom-color: #404040 !important; }
                        
                        /* Focus states */
                        .focus-option { background: #404040 !important; color: #e0e0e0 !important; border-color: #555555 !important; }
                        .focus-option.active { background: #0056b3 !important; color: #ffffff !important; }
                        
                        /* Card headers */
                        .card-header { color: #e0e0e0 !important; border-bottom-color: #404040 !important; }
                        
                        /* Override any remaining white backgrounds */
                        * { 
                            scrollbar-color: #555555 #2d2d2d !important;
                        }
                        *::-webkit-scrollbar { background: #2d2d2d !important; }
                        *::-webkit-scrollbar-thumb { background: #555555 !important; }
                        *::-webkit-scrollbar-track { background: #2d2d2d !important; }
                    </style>
                `;
                document.head.insertAdjacentHTML('beforeend', darkModeCSS);
                
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.body.classList.remove('dark-theme');
            }
            
            // Apply theme to dynamically created elements
            if (isDark) {
                applyDarkModeToExistingElements();
                
                // Set up observer for future dynamic content
                setupDarkModeObserver();
            }
            
            console.log(`üîç Dark mode ${isDark ? 'enabled' : 'disabled'} - theme attribute:`, document.documentElement.getAttribute('data-theme'));
        }
        
        function applyDarkModeToExistingElements() {
            // Apply to any existing modals
            document.querySelectorAll('[id$="-modal"]').forEach(modal => {
                modal.style.background = 'rgba(0,0,0,0.8)';
                const modalContent = modal.querySelector('div');
                if (modalContent) {
                    modalContent.style.background = '#2d2d2d';
                    modalContent.style.color = '#e0e0e0';
                    modalContent.style.borderColor = '#404040';
                }
            });
            
            // Apply to filter tabs that might be dynamically generated
            document.querySelectorAll('.filter-tab, .goal-filter-tab, .journal-filter-tab').forEach(tab => {
                if (!tab.classList.contains('active')) {
                    tab.style.background = '#404040';
                    tab.style.color = '#e0e0e0';
                    tab.style.borderColor = '#555555';
                }
            });
            
            // Apply to routine checkboxes
            document.querySelectorAll('.checkbox-item').forEach(item => {
                item.style.borderBottomColor = '#404040';
                item.style.color = '#e0e0e0';
                const label = item.querySelector('label');
                if (label) label.style.color = '#e0e0e0';
            });
            
            // Apply to dynamically generated content with specific inline styles
            document.querySelectorAll('div').forEach(div => {
                const style = div.getAttribute('style');
                if (style) {
                    // Fix gradient backgrounds
                    if (style.includes('background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)')) {
                        div.style.background = 'linear-gradient(135deg, #404040 0%, #555555 100%)';
                        div.style.color = '#e0e0e0';
                    }
                    
                    // Fix white/light backgrounds
                    if (style.includes('background: #f8f9fa') || 
                        style.includes('background: #ffffff') || 
                        style.includes('background: white')) {
                        div.style.background = '#2d2d2d';
                        div.style.color = '#e0e0e0';
                    }
                    
                    // Fix border colors
                    if (style.includes('border: 1px solid #e0e0e0') || 
                        style.includes('border-color: #e0e0e0')) {
                        div.style.borderColor = '#404040';
                    }
                    
                    // Fix text colors
                    if (style.includes('color: #333') || 
                        style.includes('color: #666') || 
                        style.includes('color: #999')) {
                        div.style.color = '#e0e0e0';
                    }
                    
                    // Fix box shadows - indicates cards/containers
                    if (style.includes('box-shadow')) {
                        if (!style.includes('background')) {
                            div.style.background = '#2d2d2d';
                        }
                        div.style.color = '#e0e0e0';
                        div.style.borderColor = '#404040';
                    }
                }
            });
            
            // Force update routine containers - AGGRESSIVE FIX
            const routineContainer = document.getElementById('current-routine');
            if (routineContainer) {
                console.log('üîß Forcing routine container to dark mode');
                routineContainer.style.background = 'transparent !important';
                
                // Fix ALL children in routine container
                routineContainer.querySelectorAll('*').forEach(element => {
                    const computedStyle = getComputedStyle(element);
                    const inlineStyle = element.getAttribute('style');
                    
                    // Force background to transparent/dark
                    element.style.setProperty('background', 'transparent', 'important');
                    element.style.setProperty('background-color', 'transparent', 'important');
                    element.style.setProperty('color', '#e0e0e0', 'important');
                    element.style.setProperty('border-color', '#404040', 'important');
                    
                    // Special handling for white backgrounds
                    if (computedStyle.backgroundColor === 'rgb(255, 255, 255)' || 
                        computedStyle.backgroundColor === 'white' ||
                        (inlineStyle && (inlineStyle.includes('background: white') || 
                                        inlineStyle.includes('background: #fff') ||
                                        inlineStyle.includes('background-color: white')))) {
                        element.style.setProperty('background-color', 'transparent', 'important');
                        console.log('üéØ Fixed white background in routine:', element);
                    }
                });
            }
            
            // Also fix any remaining white containers globally
            document.querySelectorAll('div').forEach(div => {
                const computedStyle = getComputedStyle(div);
                if (computedStyle.backgroundColor === 'rgb(255, 255, 255)' || 
                    computedStyle.backgroundColor === 'white') {
                    // Check if it's in a routine or important container
                    if (div.closest('.card') || div.closest('#current-routine') || 
                        div.classList.contains('checkbox-item') ||
                        div.classList.contains('checkbox-group')) {
                        div.style.setProperty('background-color', 'transparent', 'important');
                        div.style.setProperty('color', '#e0e0e0', 'important');
                        console.log('üéØ Fixed white background globally:', div);
                    }
                }
            });
        }
        
        function setupDarkModeObserver() {
            // Watch for new elements being added to the DOM
            const observer = new MutationObserver(mutations => {
                if (document.documentElement.getAttribute('data-theme') === 'dark') {
                    mutations.forEach(mutation => {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                applyDarkModeToElement(node);
                            }
                        });
                    });
                }
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        function applyDarkModeToElement(element) {
            // Apply dark mode to a specific element and its children
            const style = element.getAttribute('style');
            if (style) {
                // Fix common light backgrounds
                if (style.includes('background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)')) {
                    element.style.background = 'linear-gradient(135deg, #404040 0%, #555555 100%)';
                    element.style.color = '#e0e0e0';
                }
                if (style.includes('background: #f8f9fa') || 
                    style.includes('background: white') || 
                    style.includes('background: #ffffff')) {
                    element.style.background = '#2d2d2d';
                    element.style.color = '#e0e0e0';
                }
                if (style.includes('border: 1px solid #e0e0e0')) {
                    element.style.borderColor = '#404040';
                }
                if (style.includes('color: #333') || style.includes('color: #666')) {
                    element.style.color = '#e0e0e0';
                }
            }
            
            // Apply to children as well
            element.querySelectorAll('div').forEach(child => {
                const childStyle = child.getAttribute('style');
                if (childStyle) {
                    if (childStyle.includes('background: #f8f9fa') || 
                        childStyle.includes('background: white') || 
                        childStyle.includes('background: #ffffff')) {
                        child.style.background = '#2d2d2d';
                        child.style.color = '#e0e0e0';
                    }
                    if (childStyle.includes('color: #333') || 
                        childStyle.includes('color: #666') || 
                        childStyle.includes('color: #17a2b8')) {
                        child.style.color = '#e0e0e0';
                    }
                }
            });
        }
        
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        new Notification('üîî Benachrichtigungen aktiviert!', {
                            body: 'Du erh√§ltst jetzt Erinnerungen f√ºr deine Todos und Ziele.',
                            icon: '/favicon.ico'
                        });
                    }
                } catch (error) {
                    console.error('Error requesting notification permission:', error);
                }
            }
        }
        
        async function exportUserData() {
            try {
                const exportBtn = document.getElementById('exportDataBtn');
                const originalText = exportBtn.textContent;
                exportBtn.textContent = 'Exportiere...';
                exportBtn.disabled = true;
                
                // Gather all user data
                const userData = {
                    exportDate: new Date().toISOString(),
                    todos: [],
                    goals: [],
                    journalEntries: [],
                    routineCompletions: [],
                    preferences: {
                        darkMode: localStorage.getItem('dashfin-dark-mode') === 'true',
                        autoSync: localStorage.getItem('dashfin-auto-sync') !== 'false',
                        notifications: localStorage.getItem('dashfin-notifications') === 'true'
                    }
                };
                
                // Get data from Supabase if available
                if (window.supabase) {
                    userData.todos = await window.supabase.select('todos') || [];
                    userData.goals = await window.supabase.select('goals') || [];
                    userData.journalEntries = await window.supabase.select('journal_entries') || [];
                    userData.routineCompletions = await window.supabase.select('routine_completions') || [];
                }
                
                // Create download
                const dataStr = JSON.stringify(userData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `dashfin-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                console.log('‚úÖ Data exported successfully');
                
                // Reset button
                setTimeout(() => {
                    exportBtn.textContent = originalText;
                    exportBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Export failed:', error);
                alert('Fehler beim Exportieren der Daten!');
            }
        }
        
        function clearLocalCache() {
            if (confirm('Lokalen Cache leeren? Dies entfernt alle gespeicherten Pr√§ferenzen (au√üer Dark Mode).')) {
                // Clear all localStorage except theme preference
                const darkMode = localStorage.getItem('dashfin-dark-mode');
                localStorage.clear();
                if (darkMode !== null) {
                    localStorage.setItem('dashfin-dark-mode', darkMode);
                }
                
                console.log('üóëÔ∏è Local cache cleared');
                alert('Cache wurde geleert! Seite wird neu geladen...');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }

        // === ROUTINE SYSTEM FUNCTIONS ===
        
        async function loadRoutineTemplates() {
            try {
                console.log('üìã Loading routine templates...');
                
                // Get templates from cloud storage system
                const templates = await cloudStorage.getRoutineTemplates();
                console.log('Templates loaded:', templates);
                
                // Store templates globally for toggle switching
                window.routineTemplates = templates;
                
                // Start with morning routine
                await switchRoutineType('morning');
                
            } catch (error) {
                console.error('Error loading routine templates:', error);
                // Fallback: create default templates
                const defaultTemplates = [
                    {id: 'morning_1', text: 'üíß Glas Wasser trinken', routine_type: 'morning', order_index: 1},
                    {id: 'morning_2', text: 'üßò 5 Min Meditation', routine_type: 'morning', order_index: 2},
                    {id: 'morning_3', text: 'üèÉ 10 Min Bewegung', routine_type: 'morning', order_index: 3},
                    {id: 'morning_4', text: '‚òÄÔ∏è Tageslicht tanken', routine_type: 'morning', order_index: 4},
                    {id: 'morning_5', text: 'üìù 3 wichtigste Ziele definieren', routine_type: 'morning', order_index: 5},
                    {id: 'evening_1', text: 'üì± Alle Ger√§te weggelegt', routine_type: 'evening', order_index: 1},
                    {id: 'evening_2', text: 'üìñ 15 Min lesen', routine_type: 'evening', order_index: 2},
                    {id: 'evening_3', text: '‚úÖ Tag reflektieren & dankbar sein', routine_type: 'evening', order_index: 3},
                    {id: 'evening_4', text: 'üßπ Kurz aufr√§umen', routine_type: 'evening', order_index: 4},
                    {id: 'evening_5', text: 'üò¥ Vor 22:30 ins Bett', routine_type: 'evening', order_index: 5}
                ];
                
                localStorage.setItem('routine_templates_cache', JSON.stringify(defaultTemplates));
                window.routineTemplates = defaultTemplates;
                await switchRoutineType('morning');
            }
        }
        
        function renderRoutineItems(routineType, templates) {
            const container = document.getElementById('current-routine');
            if (!container) return;
            
            // Clear container
            container.innerHTML = '';
            
            templates.forEach(template => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <label class="checkbox-label">
                        <input type="checkbox" id="${template.id}" data-template-id="${template.id}">
                        <span class="checkbox-text">${template.text}</span>
                    </label>
                `;
                
                container.appendChild(item);
                
                // Add event listener for completion tracking
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', async (e) => {
                    const templateId = e.target.dataset.templateId;
                    const completed = e.target.checked;
                    const today = new Date().toISOString().split('T')[0];
                    
                    console.log(`üìã ${templateId} completion: ${completed}`);
                    
                    // Save completion to cloud
                    await cloudStorage.saveRoutineCompletion(templateId, today, completed);
                    
                    // Update streaks immediately
                    setTimeout(() => {
                        console.log('üîÑ Updating streaks after completion change...');
                        updateMonthlyRoutineStreak('morning');
                        updateMonthlyRoutineStreak('evening');
                    }, 200);
                });
            });
        }
        
        async function switchRoutineType(routineType) {
            try {
                // Use cached templates or get fresh ones
                let templates = window.routineTemplates;
                if (!templates) {
                    templates = await cloudStorage.getRoutineTemplates();
                    window.routineTemplates = templates;
                }
                
                const filteredTemplates = templates.filter(t => t.routine_type === routineType);
                console.log(`Switching to ${routineType}, found ${filteredTemplates.length} templates`);
                
                renderRoutineItems(routineType, filteredTemplates);
                await loadTodayRoutineCompletions();
                
                // Update title
                const title = document.getElementById('routine-title');
                if (title) {
                    title.textContent = routineType === 'morning' ? '‚òÄÔ∏è Morgenroutine' : 'üåô Abendroutine';
                }
                
            } catch (error) {
                console.error('Error switching routine type:', error);
            }
        }
        
        async function loadTodayRoutineCompletions() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const completions = await cloudStorage.getRoutineCompletions(today);
                
                completions.forEach(completion => {
                    const checkbox = document.getElementById(completion.template_id);
                    if (checkbox) {
                        checkbox.checked = completion.completed;
                    }
                });
                
            } catch (error) {
                console.error('Error loading routine completions:', error);
            }
        }
        
        // === QUICK FIX FOR ROUTINES ===
        function initializeRoutineTemplates() {
            console.log('üîß Force initializing routine templates...');
            
            const templates = [
                {id: 'morning_1', text: 'üíß Glas Wasser trinken', routine_type: 'morning', order_index: 1},
                {id: 'morning_2', text: 'üßò 5 Min Meditation', routine_type: 'morning', order_index: 2},
                {id: 'morning_3', text: 'üèÉ 10 Min Bewegung', routine_type: 'morning', order_index: 3},
                {id: 'morning_4', text: '‚òÄÔ∏è Tageslicht tanken', routine_type: 'morning', order_index: 4},
                {id: 'morning_5', text: 'üìù 3 wichtigste Ziele definieren', routine_type: 'morning', order_index: 5},
                {id: 'evening_1', text: 'üì± Alle Ger√§te weggelegt', routine_type: 'evening', order_index: 1},
                {id: 'evening_2', text: 'üìñ 15 Min lesen', routine_type: 'evening', order_index: 2},
                {id: 'evening_3', text: '‚úÖ Tag reflektieren & dankbar sein', routine_type: 'evening', order_index: 3},
                {id: 'evening_4', text: 'üßπ Kurz aufr√§umen', routine_type: 'evening', order_index: 4},
                {id: 'evening_5', text: 'üò¥ Vor 22:30 ins Bett', routine_type: 'evening', order_index: 5}
            ];
            
            localStorage.setItem('routine_templates_cache', JSON.stringify(templates));
            window.routineTemplates = templates;
            
            // Force render morning routine
            const morningTemplates = templates.filter(t => t.routine_type === 'morning');
            renderRoutineItems('morning', morningTemplates);
            
            console.log('‚úÖ Templates initialized, rendered morning routine');
        }
        
        // Call this immediately when page loads
        setTimeout(initializeRoutineTemplates, 1000);
        
        // === STREAK CALCULATION FUNCTIONS ===
        
        function calculateRoutineStreak(routineType) {
            try {
                console.log(`üîÑ Calculating ${routineType} streak...`);
                
                // Get all completions from new system
                const completions = cloudStorage.getLocalRoutineCompletions();
                if (!completions || completions.length === 0) {
                    console.log(`No completions found for ${routineType}`);
                    return 0;
                }
                
                const today = new Date();
                let streak = 0;
                
                // Check consecutive days backwards from today
                for (let i = 0; i < 365; i++) { // Max 365 day streak
                    const checkDate = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                    const dateStr = checkDate.toISOString().split('T')[0];
                    
                    // Check if all routine items were completed for this date and routine type
                    const dayCompletions = completions.filter(c => 
                        c.date === dateStr && 
                        c.template_id.startsWith(routineType) && 
                        c.completed
                    );
                    
                    // Count unique completed items for this day
                    const completedItems = new Set(dayCompletions.map(c => c.template_id)).size;
                    const totalItems = 5; // We have 5 items per routine
                    
                    if (completedItems === totalItems) {
                        streak++;
                        console.log(`‚úÖ ${routineType} completed on ${dateStr} (${completedItems}/${totalItems})`);
                    } else {
                        console.log(`‚ùå ${routineType} incomplete on ${dateStr} (${completedItems}/${totalItems})`);
                        break; // Streak broken
                    }
                }
                
                console.log(`üî• ${routineType} final streak: ${streak}`);
                return streak;
                
            } catch (error) {
                console.error('Error calculating routine streak:', error);
                return 0;
            }
        }
        
        function updateMonthlyRoutineStreak(routineType) {
            try {
                console.log(`üìä Updating ${routineType} streak display...`);
                
                // Calculate consecutive daily streak from new completion system
                const streak = calculateRoutineStreak(routineType);
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const MONTH_NAMES = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                                     'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                
                // Update streak tiles
                const countElement = document.getElementById(`${routineType}RoutineStreakCount`);
                const dateElement = document.getElementById(`${routineType}RoutineStreakDate`);
                
                if (countElement) {
                    countElement.textContent = streak;
                    console.log(`‚úÖ Updated ${routineType} streak count to: ${streak}`);
                }
                
                if (dateElement) {
                    dateElement.textContent = `${MONTH_NAMES[currentMonth]} ${currentYear}`;
                }
                
            } catch (error) {
                console.error(`Error in updateMonthlyRoutineStreak(${routineType}):`, error);
            }
        }
        
        // === RESTORE TAB FUNCTIONS ===
        
        function checkCurrentRoutineData() {
            const status = document.getElementById('restore-status');
            
            // Check localStorage routine data
            const routineCompletionData = localStorage.getItem('routineCompletionData');
            const routineResetTime = localStorage.getItem('routineResetTime');
            const lastRoutineResetDate = localStorage.getItem('lastRoutineResetDate');
            
            let html = '<h3>Current Routine Data:</h3>';
            
            if (routineCompletionData) {
                try {
                    const data = JSON.parse(routineCompletionData);
                    html += `<div style="background: #f5f5f5; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace; font-size: 0.9rem;">
                        <strong>Completion Data:</strong><br>
                        ${JSON.stringify(data, null, 2)}
                    </div>`;
                } catch (e) {
                    html += `<div style="background: #fee; color: #c33; padding: 1rem; border-radius: 6px;">Error parsing completion data: ${e.message}</div>`;
                }
            } else {
                html += `<div style="background: #fee; color: #c33; padding: 1rem; border-radius: 6px;">No routine completion data found</div>`;
            }
            
            html += `<div style="background: #f5f5f5; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace; font-size: 0.9rem;">
                <strong>Reset Time:</strong> ${routineResetTime || 'Not set'}<br>
                <strong>Last Reset Date:</strong> ${lastRoutineResetDate || 'Not set'}
            </div>`;
            
            status.innerHTML = html;
        }
        
        function setFiveDayStreaks() {
            const status = document.getElementById('restore-status');
            
            const completions = [];
            const today = new Date();
            
            // Generate 5 days of completions for both morning and evening routines
            for (let i = 0; i < 5; i++) {
                const date = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toISOString().split('T')[0];
                
                // Morning routine completions (all 5 items)
                for (let j = 1; j <= 5; j++) {
                    completions.push({
                        id: `morning_${j}_${dateStr}`,
                        template_id: `morning_${j}`,
                        date: dateStr,
                        completed: true,
                        user_id: 'manual'
                    });
                }
                
                // Evening routine completions (all 5 items)
                for (let j = 1; j <= 5; j++) {
                    completions.push({
                        id: `evening_${j}_${dateStr}`,
                        template_id: `evening_${j}`,
                        date: dateStr,
                        completed: true,
                        user_id: 'manual'
                    });
                }
            }
            
            // Save to localStorage
            localStorage.setItem('routine_completions_cache', JSON.stringify(completions));
            
            // Clean templates
            const templates = [
                {id: 'morning_1', text: 'üíß Glas Wasser trinken', routine_type: 'morning', order_index: 1},
                {id: 'morning_2', text: 'üßò 5 Min Meditation', routine_type: 'morning', order_index: 2},
                {id: 'morning_3', text: 'üì± Handy Check vermeiden', routine_type: 'morning', order_index: 3},
                {id: 'morning_4', text: '‚òÄÔ∏è Tageslicht tanken', routine_type: 'morning', order_index: 4},
                {id: 'morning_5', text: 'üìù Tagesplan machen', routine_type: 'morning', order_index: 5},
                {id: 'evening_1', text: 'üì± Handy weggelegen', routine_type: 'evening', order_index: 1},
                {id: 'evening_2', text: 'üìñ 10 Min lesen', routine_type: 'evening', order_index: 2},
                {id: 'evening_3', text: '‚úÖ Tag reflektieren', routine_type: 'evening', order_index: 3},
                {id: 'evening_4', text: 'üåô Zimmer abdunkeln', routine_type: 'evening', order_index: 4},
                {id: 'evening_5', text: 'üò¥ Fr√ºh ins Bett', routine_type: 'evening', order_index: 5}
            ];
            
            localStorage.setItem('routine_templates_cache', JSON.stringify(templates));
            
            status.innerHTML += `<div style="background: #efe; color: #363; padding: 1rem; border-radius: 6px;">‚úÖ Set 5-day streaks for both routines (${completions.length} completions)</div>`;
            status.innerHTML += `<div style="background: #efe; color: #363; padding: 1rem; border-radius: 6px;"><strong>Go to Home tab - both routines should show streak of 5!</strong></div>`;
        }
        
        function restoreRoutineData() {
            const status = document.getElementById('restore-status');
            
            // Get existing data
            const routineCompletionData = localStorage.getItem('routineCompletionData');
            
            if (!routineCompletionData) {
                status.innerHTML += '<div style="background: #fee; color: #c33; padding: 1rem; border-radius: 6px;">No routine data to restore</div>';
                return;
            }
            
            try {
                const oldData = JSON.parse(routineCompletionData);
                
                // Convert old format to new format
                const completions = [];
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0];
                
                // Process morning routines
                if (oldData.morningRoutine) {
                    Object.keys(oldData.morningRoutine).forEach((routineId, index) => {
                        const templateId = `morning_${index + 1}`;
                        if (oldData.morningRoutine[routineId]) {
                            // Add completion for yesterday to restore streak
                            completions.push({
                                id: `${templateId}_${yesterday}`,
                                template_id: templateId,
                                date: yesterday,
                                completed: true,
                                user_id: 'restored'
                            });
                            // Add for today if completed
                            completions.push({
                                id: `${templateId}_${today}`,
                                template_id: templateId,
                                date: today,
                                completed: true,
                                user_id: 'restored'
                            });
                        }
                    });
                }
                
                // Process evening routines
                if (oldData.eveningRoutine) {
                    Object.keys(oldData.eveningRoutine).forEach((routineId, index) => {
                        const templateId = `evening_${index + 1}`;
                        if (oldData.eveningRoutine[routineId]) {
                            // Add completion for yesterday to restore streak
                            completions.push({
                                id: `${templateId}_${yesterday}`,
                                template_id: templateId,
                                date: yesterday,
                                completed: true,
                                user_id: 'restored'
                            });
                            // Add for today if completed
                            completions.push({
                                id: `${templateId}_${today}`,
                                template_id: templateId,
                                date: today,
                                completed: true,
                                user_id: 'restored'
                            });
                        }
                    });
                }
                
                // Save to new format
                localStorage.setItem('routine_completions_cache', JSON.stringify(completions));
                
                // Clean templates
                const templates = [
                    {id: 'morning_1', text: 'üíß Glas Wasser trinken', routine_type: 'morning', order_index: 1},
                    {id: 'morning_2', text: 'üßò 5 Min Meditation', routine_type: 'morning', order_index: 2},
                    {id: 'morning_3', text: 'üì± Handy Check vermeiden', routine_type: 'morning', order_index: 3},
                    {id: 'morning_4', text: '‚òÄÔ∏è Tageslicht tanken', routine_type: 'morning', order_index: 4},
                    {id: 'morning_5', text: 'üìù Tagesplan machen', routine_type: 'morning', order_index: 5},
                    {id: 'evening_1', text: 'üì± Handy weggelegen', routine_type: 'evening', order_index: 1},
                    {id: 'evening_2', text: 'üìñ 10 Min lesen', routine_type: 'evening', order_index: 2},
                    {id: 'evening_3', text: '‚úÖ Tag reflektieren', routine_type: 'evening', order_index: 3},
                    {id: 'evening_4', text: 'üåô Zimmer abdunkeln', routine_type: 'evening', order_index: 4},
                    {id: 'evening_5', text: 'üò¥ Fr√ºh ins Bett', routine_type: 'evening', order_index: 5}
                ];
                
                localStorage.setItem('routine_templates_cache', JSON.stringify(templates));
                
                status.innerHTML += `<div style="background: #efe; color: #363; padding: 1rem; border-radius: 6px;">‚úÖ Restored ${completions.length} routine completions</div>`;
                status.innerHTML += `<div style="background: #efe; color: #363; padding: 1rem; border-radius: 6px;">Templates cleaned and restored</div>`;
                
            } catch (error) {
                status.innerHTML += `<div style="background: #fee; color: #c33; padding: 1rem; border-radius: 6px;">Error restoring routines: ${error.message}</div>`;
            }
        }
        
        function cleanupRoutineData() {
            const status = document.getElementById('restore-status');
            
            // Remove old format data
            localStorage.removeItem('routineCompletionData');
            localStorage.removeItem('routines_cache');
            
            // Clean any duplicate keys
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('routine') && !key.includes('_cache') && !key.includes('ResetTime') && !key.includes('ResetDate')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                status.innerHTML += `<div style="background: #eef; color: #336; padding: 0.5rem; border-radius: 6px; margin: 0.5rem 0;">Removed: ${key}</div>`;
            });
            
            status.innerHTML += `<div style="background: #efe; color: #363; padding: 1rem; border-radius: 6px;">‚úÖ Cleanup completed</div>`;
            status.innerHTML += `<div style="background: #efe; color: #363; padding: 1rem; border-radius: 6px;"><strong>Now go to Home tab to see restored routines!</strong></div>`;
        }
    </script>
</body>
</html>