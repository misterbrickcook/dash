<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ HYBRID DASHBOARD - With Todo Filters! üöÄ</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- === BEAUTIFUL STICKY NAVIGATION === -->
    <nav class="sticky-nav">
        <div class="nav-container">
            <div class="nav-link active" data-tab="home">Home</div>
            <div class="nav-link" data-tab="todos">ToDos</div>
            <div class="nav-link" data-tab="ziele">Ziele</div>
            <div class="nav-link" data-tab="journal">Journal</div>
            <div class="nav-link" data-tab="motivation">Motivation</div>
            <div class="nav-link" data-tab="ressourcen">Ressourcen</div>
            <div class="nav-link" data-tab="settings">Settings</div>
        </div>
    </nav>

    <div class="main-content">
        
        <!-- === üè† HOME TAB === -->
        <div class="tab-content active" id="home">
            <!-- üî• Streak √úbersicht -->
            <section class="streak-overview">
                <div class="streak-grid">
                    <div class="streak-tile" id="morningRoutineStreak">
                        <div class="streak-number" id="morningRoutineStreakCount">0</div>
                        <div class="streak-label">Morgenroutine</div>
                        <div class="streak-date" id="morningRoutineStreakDate">August 2025</div>
                    </div>
                    <div class="streak-tile" id="eveningRoutineStreak">
                        <div class="streak-number" id="eveningRoutineStreakCount">0</div>
                        <div class="streak-label">Abendroutine</div>
                        <div class="streak-date" id="eveningRoutineStreakDate">August 2025</div>
                    </div>
                    <div class="streak-tile" id="todoStreak">
                        <div class="streak-number" id="todoStreakCount">0</div>
                        <div class="streak-label">Todo Streak</div>
                        <div class="streak-date" id="todoStreakDate">August 2025</div>
                    </div>
                </div>
            </section>

            <!-- ‚òÄÔ∏è Routines Section -->
            <section class="section">
                <div class="card-header">
                    <h2 id="routine-title">‚òÄÔ∏è Morgenroutine</h2>
                    <div class="focus-toggle">
                        <div class="focus-option active" data-routine="morning">‚òÄÔ∏è</div>
                        <div class="focus-option" data-routine="evening">üåô</div>
                    </div>
                </div>
                
                <!-- Cloud-synced routines -->
                <div class="checkbox-group" id="current-routine">
                    <div class="loading-placeholder" style="text-align: center; padding: 1rem; color: #666;">
                        ‚òÅÔ∏è Loading routines from cloud...
                    </div>
                </div>
            </section>

            <!-- üìã Heutige Aufgaben (Cloud-Synced) -->
            <section class="card">
                <div class="card-header">
                    <h2>üìã Heutige Aufgaben</h2>
                    <button id="add-todo-btn" style="padding: 0.3rem 0.8rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + Add Todo
                    </button>
                </div>
                
                <!-- Cloud-synced todos -->
                <div class="checkbox-group" id="home-todos">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading todos from cloud...
                    </div>
                </div>
            </section>
        </div>

        <!-- === ‚úÖ TODOS TAB === -->
        <div class="tab-content" id="todos">
            <section class="card">
                <div class="card-header">
                    <h2 id="todos-section-title">Active Todos</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="add-todo-btn-2" style="padding: 0.3rem 0.8rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            + Add Todo
                        </button>
                        <button id="clear-archive-btn" style="padding: 0.3rem 0.8rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: none;">
                            üóëÔ∏è Clear Archive
                        </button>
                    </div>
                </div>
                
                <!-- Todo Filter Tabs - Generated by JavaScript -->
                <div class="filter-tabs" style="display: flex; gap: 0.5rem; margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <!-- Filter tabs will be created dynamically -->
                </div>
                
                <div class="checkbox-group" id="active-todos">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading active todos...
                    </div>
                </div>
            </section>

            <!-- Note: Archived todos now available via "Archiv" filter tab -->
        </div>

        <!-- === üéØ ZIELE TAB === -->
        <div class="tab-content" id="ziele">
            <section class="card">
                <div class="card-header">
                    <h2 id="goals-section-title">üéØ Active Goals</h2>
                    <button id="add-goal-btn" style="padding: 0.3rem 0.8rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + Add Goal
                    </button>
                </div>
                
                <!-- Goal Filter Tabs -->
                <div class="goal-filter-tabs" style="display: flex; gap: 0.5rem; margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                    <!-- Filter tabs will be created dynamically -->
                </div>
                
                <div class="checkbox-group" id="active-goals">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading goals from cloud...
                    </div>
                </div>
            </section>

            <!-- Note: Completed goals now available via "Erreicht" filter tab -->
        </div>

        <!-- === üìî JOURNAL TAB === -->
        <div class="tab-content" id="journal">
            <section class="card">
                <div class="card-header">
                    <h2>üìî Daily Journal</h2>
                    <button id="add-journal-btn" style="padding: 0.3rem 0.8rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        + New Entry
                    </button>
                </div>
                
                <div id="journal-entries">
                    <div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">
                        ‚òÅÔ∏è Loading journal entries...
                    </div>
                </div>
            </section>
        </div>

        <!-- === ‚ö° MOTIVATION TAB === -->
        <div class="tab-content" id="motivation">
            <section class="card">
                <div class="card-header">
                    <h2>‚ö° Daily Motivation</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    üí™ Motivation system coming soon!
                </div>
            </section>
        </div>

        <!-- === üìö RESSOURCEN TAB === -->
        <div class="tab-content" id="ressourcen">
            <section class="card">
                <div class="card-header">
                    <h2>üìö Resources & Links</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    üîó Resources coming soon!
                </div>
            </section>
        </div>

        <!-- === ‚öôÔ∏è SETTINGS TAB === -->
        <div class="tab-content" id="settings">
            <section class="card">
                <div class="card-header">
                    <h2>‚öôÔ∏è Settings</h2>
                </div>
                
                <div style="text-align: center; color: #666; padding: 2rem;">
                    ‚öôÔ∏è Settings panel coming soon!
                </div>
            </section>
        </div>

    </div>

    <!-- Scripts -->
    <script src="supabase-config.js?v=4"></script>
    <script src="cloud-storage.js?v=3"></script>
    <script src="script.js?v=3"></script>
    
    <!-- HYBRID SYSTEM: Beautiful UI + Working Cloud Sync -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ HYBRID DASHBOARD - Beautiful UI + Cloud Sync');
            
            // Initialize navigation
            initializeNavigation();
            
            // Initialize Supabase
            const connected = initializeSupabase();
            
            if (connected && window.supabase) {
                console.log('‚úÖ Database connected - loading data...');
                await loadAndRenderTodos();
                await loadAndRenderGoals();
                await loadAndRenderJournal();
                await loadAndRenderRoutines();
                setupTodoButtons();
                setupGoalButtons();
                setupJournalButtons();
                setupRoutineToggles();
                await initializeStreaks();
            } else {
                // Even without database, setup filter tabs
                setupFilterTabs();
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.getAttribute('data-tab');
                    
                    // Remove active from all
                    navLinks.forEach(l => l.classList.remove('active'));
                    tabContents.forEach(t => t.classList.remove('active'));
                    
                    // Add active to clicked
                    link.classList.add('active');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                });
            });
        }
        
        async function loadAndRenderTodos() {
            try {
                const todos = await window.supabase.select('todos', '*', 'created_at.desc');
                console.log(`üìä Loaded ${todos?.length || 0} todos from cloud`);
                
                if (todos && todos.length > 0) {
                    renderTodos(todos);
                } else {
                    clearLoadingMessages();
                }
            } catch (error) {
                console.error('‚ùå Failed to load todos:', error);
            }
        }
        
        let currentFilter = 'alle';
        
        function renderTodos(todos) {
            const homeContainer = document.getElementById('home-todos');
            const activeContainer = document.getElementById('active-todos');
            
            // Clear containers
            if (homeContainer) homeContainer.innerHTML = '';
            if (activeContainer) activeContainer.innerHTML = '';
            
            const activeTodos = todos.filter(t => !t.completed);
            const completedTodos = todos.filter(t => t.completed);
            
            // Filter todos based on current filter and handle overdue logic
            let filteredActiveTodos, filteredCompletedTodos;
            
            // Process todos for overdue status and auto-categorization
            const processedTodos = processTodosForToday(activeTodos);
            
            if (currentFilter === 'alle') {
                filteredActiveTodos = processedTodos;
                filteredCompletedTodos = [];  // Don't show completed in 'alle' view
            } else if (currentFilter === 'archiv') {
                filteredActiveTodos = [];     // Don't show active in archive view
                filteredCompletedTodos = completedTodos;
            } else if (currentFilter === 'heute') {
                // Show today's todos AND overdue todos
                filteredActiveTodos = processedTodos.filter(t => t.category === 'heute');
                filteredCompletedTodos = [];
            } else {
                filteredActiveTodos = processedTodos.filter(t => t.category === currentFilter);
                filteredCompletedTodos = []; // Don't show completed in category views
            }
            
            // Render active todos (filtered)
            filteredActiveTodos.forEach(todo => {
                const categoryIcon = getCategoryIcon(todo.category);
                
                // Format due date/time if available
                let dueDateDisplay = '';
                if (todo.due_date) {
                    const dueDate = new Date(todo.due_date);
                    const today = new Date();
                    const isToday = dueDate.toDateString() === today.toDateString();
                    
                    if (todo.isOverdue) {
                        dueDateDisplay = `<small style="color: #dc3545; margin-left: 0.5rem; font-weight: bold;">‚ö†Ô∏è √úBERF√ÑLLIG ${dueDate.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}</small>`;
                    } else if (isToday) {
                        dueDateDisplay = `<small style="color: #17a2b8; margin-left: 0.5rem;">‚è∞ ${dueDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</small>`;
                    } else {
                        dueDateDisplay = `<small style="color: #666; margin-left: 0.5rem;">üìÖ ${dueDate.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}</small>`;
                    }
                }
                
                const todoHTML = `
                    <div class="checkbox-item" data-category="${todo.category}">
                        <input type="checkbox" data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                        <label>${categoryIcon} ${todo.text}${dueDateDisplay}</label>
                        <span class="todo-category" style="margin-left: auto; color: #666; font-size: 0.7rem; text-transform: uppercase;">${todo.category}</span>
                    </div>
                `;
                activeContainer.insertAdjacentHTML('beforeend', todoHTML);
            });
            
            // Render home todos (heute category only, including overdue)
            if (homeContainer) {
                const heuteTodos = processedTodos.filter(t => t.category === 'heute');
                heuteTodos.forEach(todo => {
                    const categoryIcon = getCategoryIcon(todo.category);
                    
                    // Format due time for home display
                    let dueDateDisplay = '';
                    if (todo.due_date) {
                        const dueDate = new Date(todo.due_date);
                        if (todo.isOverdue) {
                            dueDateDisplay = `<small style="color: #dc3545; margin-left: 0.5rem; font-weight: bold;">‚ö†Ô∏è √úBERF√ÑLLIG</small>`;
                        } else {
                            dueDateDisplay = `<small style="color: #17a2b8; margin-left: 0.5rem;">‚è∞ ${dueDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</small>`;
                        }
                    }
                    
                    const todoHTML = `
                        <div class="checkbox-item" data-category="${todo.category}" ${todo.isOverdue ? 'style="border-left: 3px solid #dc3545; padding-left: 0.5rem;"' : ''}>
                            <input type="checkbox" data-cloud-id="${todo.id}" onchange="syncTodoChange('${todo.id}', this.checked)">
                            <label>${categoryIcon} ${todo.text}${dueDateDisplay}</label>
                        </div>
                    `;
                    homeContainer.insertAdjacentHTML('beforeend', todoHTML);
                });
            }
            
            // Render completed todos (only in archive view)
            if (activeContainer) {
                if (filteredCompletedTodos.length > 0) {
                    filteredCompletedTodos.forEach(todo => {
                        const categoryIcon = getCategoryIcon(todo.category);
                        const archivedHTML = `
                            <div class="checkbox-item" style="opacity: 0.7;" data-category="${todo.category}">
                                <input type="checkbox" checked disabled>
                                <label style="text-decoration: line-through; color: #999;">${categoryIcon} ${todo.text}</label>
                                <span style="margin-left: auto; color: #666; font-size: 0.8rem;">üìÅ</span>
                            </div>
                        `;
                        activeContainer.insertAdjacentHTML('beforeend', archivedHTML);
                    });
                } else if (currentFilter === 'archiv') {
                    // Show empty archive message
                    activeContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">üìÅ Archiv ist leer</div>';
                }
            }
            
            // Update section title
            const titleEl = document.getElementById('todos-section-title');
            if (titleEl) {
                if (currentFilter === 'alle') {
                    titleEl.textContent = 'Active Todos';
                } else if (currentFilter === 'archiv') {
                    titleEl.textContent = 'üìÅ Archived Todos';
                } else {
                    titleEl.textContent = `${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} Todos`;
                }
            }
            
            console.log(`‚úÖ Rendered ${filteredActiveTodos.length} active, ${filteredCompletedTodos.length} completed (${currentFilter})`);
        }
        
        function getCategoryIcon(category) {
            const icons = {
                'heute': 'üìÖ',
                'privat': 'üè†',
                'uni': 'üéì',
                'arbeit': 'üíº'
            };
            return icons[category] || 'üìù';
        }
        
        function processTodosForToday(todos) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            return todos.map(todo => {
                const processedTodo = { ...todo };
                
                // Check if todo has a due date and is overdue
                if (todo.due_date) {
                    const dueDate = new Date(todo.due_date);
                    dueDate.setHours(0, 0, 0, 0); // Start of due date
                    
                    // If due date is before today, mark as overdue and categorize as 'heute'
                    if (dueDate < today) {
                        processedTodo.isOverdue = true;
                        processedTodo.category = 'heute'; // Move overdue todos to 'heute' category
                    }
                }
                
                return processedTodo;
            });
        }
        
        function clearLoadingMessages() {
            document.querySelectorAll('.loading-placeholder').forEach(el => {
                el.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No todos yet - click + to add one!</div>';
            });
        }
        
        function setupFilterTabs() {
            console.log('üîß Setting up filter tabs...');
            
            // Create filter tabs dynamically
            const filterContainer = document.querySelector('.filter-tabs');
            if (!filterContainer) {
                console.log('‚ùå Filter container not found');
                return;
            }
            
            const filters = [
                { id: 'alle', label: 'Alle', icon: '' },
                { id: 'heute', label: 'Heute', icon: 'üìÖ' },
                { id: 'privat', label: 'Privat', icon: 'üè†' },
                { id: 'uni', label: 'Uni', icon: 'üéì' },
                { id: 'arbeit', label: 'Arbeit', icon: 'üíº' },
                { id: 'archiv', label: 'Archiv', icon: 'üìÅ' }
            ];
            
            // Clear and rebuild filter tabs
            filterContainer.innerHTML = '';
            
            filters.forEach(filter => {
                const button = document.createElement('button');
                button.className = 'filter-tab' + (filter.id === 'alle' ? ' active' : '');
                button.setAttribute('data-filter', filter.id);
                button.textContent = filter.icon ? `${filter.icon} ${filter.label}` : filter.label;
                button.style.cssText = filter.id === 'alle' 
                    ? 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #007bff; color: white; cursor: pointer; font-size: 0.8rem;'
                    : 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                
                button.addEventListener('click', () => {
                    console.log(`üîç Filter clicked: ${filter.id}`);
                    
                    // Update all tabs
                    document.querySelectorAll('.filter-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                    });
                    
                    // Activate clicked tab
                    button.classList.add('active');
                    button.style.cssText = 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #007bff; color: white; cursor: pointer; font-size: 0.8rem;';
                    
                    // Update filter
                    currentFilter = filter.id;
                    
                    // Re-render
                    if (window.supabase) {
                        loadAndRenderTodos();
                    }
                    
                    // Show/hide archive clear button
                    toggleArchiveClearButton();
                });
                
                filterContainer.appendChild(button);
            });
            
            console.log(`‚úÖ Created ${filters.length} filter tabs`);
            
            // Initial button state
            toggleArchiveClearButton();
        }
        
        function setupTodoButtons() {
            document.getElementById('add-todo-btn').addEventListener('click', addNewTodo);
            document.getElementById('add-todo-btn-2').addEventListener('click', addNewTodo);
            document.getElementById('clear-archive-btn').addEventListener('click', clearArchive);
            setupFilterTabs();
        }
        
        function toggleArchiveClearButton() {
            const clearBtn = document.getElementById('clear-archive-btn');
            if (clearBtn) {
                clearBtn.style.display = currentFilter === 'archiv' ? 'block' : 'none';
            }
        }
        
        async function clearArchive() {
            if (!confirm('Alle archivierten Todos permanent l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                return;
            }
            
            try {
                // Get all completed todos
                const allTodos = await window.supabase.select('todos');
                const completedTodos = allTodos?.filter(t => t.completed) || [];
                
                if (completedTodos.length === 0) {
                    alert('Kein Archiv zum Leeren vorhanden.');
                    return;
                }
                
                // Delete all completed todos
                for (const todo of completedTodos) {
                    await window.supabase.delete('todos', todo.id);
                }
                
                console.log(`üóëÔ∏è Cleared ${completedTodos.length} archived todos`);
                
                // Immediately clear the display to prevent old data showing
                const activeContainer = document.getElementById('active-todos');
                if (activeContainer) {
                    if (currentFilter === 'archiv') {
                        activeContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">üìÅ Archiv ist leer</div>';
                    } else {
                        // Clear any old content for other filters
                        activeContainer.innerHTML = '<div class="loading-placeholder" style="text-align: center; color: #666; padding: 1rem;">‚òÅÔ∏è Loading todos...</div>';
                    }
                }
                
                // Refresh display - force reload from database
                await loadAndRenderTodos();
                
                alert(`${completedTodos.length} archivierte Todos wurden gel√∂scht.`);
                
            } catch (error) {
                console.error('‚ùå Failed to clear archive:', error);
                alert('Fehler beim Leeren des Archivs!');
            }
        }
        
        function showAddTodoModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="todo-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üìù Neues Todo</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Text:</label>
                            <input type="text" id="todo-text-input" placeholder="Todo beschreibung..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Kategorie:</label>
                            <select id="todo-category-modal" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="privat">üè† Privat</option>
                                <option value="uni">üéì Uni</option>
                                <option value="arbeit">üíº Arbeit</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Datum (optional):</label>
                            <input type="date" id="todo-date-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Uhrzeit (optional):</label>
                            <input type="time" id="todo-time-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="closeTodoModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                            <button onclick="saveTodo()" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Set default date to today and time to 20:00
            document.getElementById('todo-date-input').value = new Date().toISOString().split('T')[0];
            document.getElementById('todo-time-input').value = '20:00';
            
            // Focus on text input
            document.getElementById('todo-text-input').focus();
        }
        
        function closeTodoModal() {
            const modal = document.getElementById('todo-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveTodo() {
            const textInput = document.getElementById('todo-text-input');
            const categoryInput = document.getElementById('todo-category-modal');
            const dateInput = document.getElementById('todo-date-input');
            const timeInput = document.getElementById('todo-time-input');
            
            const todoText = textInput.value.trim();
            if (!todoText) {
                alert('Bitte Todo-Text eingeben!');
                textInput.focus();
                return;
            }
            
            let category = categoryInput.value;
            const date = dateInput.value;
            const time = timeInput.value;
            
            // Build due date/time if provided
            let dueDate = null;
            if (date) {
                if (time) {
                    dueDate = new Date(`${date}T${time}`).toISOString();
                } else {
                    dueDate = new Date(`${date}T12:00:00`).toISOString();
                }
                
                // Auto-set category to "heute" if date is today
                const today = new Date().toISOString().split('T')[0];
                if (date === today) {
                    category = 'heute';
                }
            }
            
            const newTodo = {
                id: 'todo_' + Date.now(),
                text: todoText,
                completed: false,
                category: category,
                due_date: dueDate,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('todos', newTodo);
                console.log(`‚úÖ Todo added to cloud (${category}):`, todoText);
                closeTodoModal();
                await loadAndRenderTodos(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to add todo:', error);
                alert('Fehler beim Speichern des Todos!');
            }
        }
        
        async function addNewTodo() {
            showAddTodoModal();
        }
        
        // === GOALS SYSTEM ===
        async function loadAndRenderGoals() {
            try {
                const goals = await window.supabase.select('goals');
                console.log(`üìä Loaded ${goals?.length || 0} goals from cloud`);
                
                if (goals && goals.length > 0) {
                    renderGoals(goals);
                } else {
                    clearGoalLoadingMessages();
                }
            } catch (error) {
                console.error('‚ùå Failed to load goals:', error);
            }
        }
        
        function getCategoryIconGoal(category) {
            const icons = {
                'personal': 'üå±',
                'career': 'üíº',
                'health': 'üí™',
                'finance': 'üí∞',
                'education': 'üìö',
                'other': 'üéØ'
            };
            return icons[category] || 'üéØ';
        }
        
        function renderGoals(goals) {
            const activeContainer = document.getElementById('active-goals');
            
            // Clear container
            if (activeContainer) activeContainer.innerHTML = '';
            
            const activeGoals = goals.filter(g => !g.completed);
            const completedGoals = goals.filter(g => g.completed);
            
            // Filter goals based on current filter
            let filteredGoals;
            if (currentGoalFilter === 'active') {
                filteredGoals = activeGoals;
            } else if (currentGoalFilter === 'completed') {
                filteredGoals = completedGoals;
            }
            
            // Render filtered goals
            if (activeContainer) {
                if (filteredGoals.length > 0) {
                    filteredGoals.forEach(goal => {
                        const categoryIcon = getCategoryIconGoal(goal.category);
                        
                        if (currentGoalFilter === 'active') {
                            // Format target date for active goals
                            let targetDateDisplay = '';
                            if (goal.target_date) {
                                const targetDate = new Date(goal.target_date);
                                const today = new Date();
                                const isOverdue = targetDate < today;
                                
                                if (isOverdue) {
                                    targetDateDisplay = `<div style="color: #dc3545; font-size: 0.8rem; margin-top: 0.5rem;">‚ö†Ô∏è √úberf√§llig: ${targetDate.toLocaleDateString('de-DE')}</div>`;
                                } else {
                                    targetDateDisplay = `<div style="color: #666; font-size: 0.8rem; margin-top: 0.5rem;">üéØ Ziel: ${targetDate.toLocaleDateString('de-DE')}</div>`;
                                }
                            }
                            
                            const goalHTML = `
                                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                        <input type="checkbox" data-cloud-id="${goal.id}" onchange="syncGoalChange('${goal.id}', this.checked)" style="margin-top: 0.2rem;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.2rem;">${categoryIcon}</span>
                                                <h4 style="margin: 0; color: #333; font-size: 1rem;">${goal.title}</h4>
                                            </div>
                                            ${goal.description ? `<p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem; line-height: 1.4;">${goal.description}</p>` : ''}
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                                <span style="background: #28a745; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; text-transform: uppercase;">${goal.category}</span>
                                                ${targetDateDisplay}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            activeContainer.insertAdjacentHTML('beforeend', goalHTML);
                        } else {
                            // Render completed goal
                            const completedHTML = `
                                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8f9fa; opacity: 0.7;">
                                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                        <input type="checkbox" checked disabled style="margin-top: 0.2rem;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.2rem;">üèÜ</span>
                                                <h4 style="margin: 0; color: #666; font-size: 1rem; text-decoration: line-through;">${goal.title}</h4>
                                            </div>
                                            ${goal.description ? `<p style="margin: 0.5rem 0; color: #999; font-size: 0.9rem; text-decoration: line-through;">${goal.description}</p>` : ''}
                                            <span style="background: #6c757d; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem;">ERREICHT ‚úÖ</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            activeContainer.insertAdjacentHTML('beforeend', completedHTML);
                        }
                    });
                } else {
                    // Show empty message
                    const emptyMessage = currentGoalFilter === 'active' 
                        ? 'Keine aktiven Ziele - klicke + um eins hinzuzuf√ºgen!'
                        : 'üèÜ Keine erreichten Ziele vorhanden';
                    activeContainer.innerHTML = `<div style="text-align: center; color: #666; padding: 1rem;">${emptyMessage}</div>`;
                }
            }
            
            // Update section title
            const titleEl = document.getElementById('goals-section-title');
            if (titleEl) {
                titleEl.textContent = currentGoalFilter === 'active' ? 'üéØ Active Goals' : 'üèÜ Erreichte Ziele';
            }
            
            console.log(`‚úÖ Rendered ${filteredGoals?.length || 0} goals (${currentGoalFilter})`);
        }
        
        function clearGoalLoadingMessages() {
            const activeContainer = document.getElementById('active-goals');
            if (activeContainer) {
                activeContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No goals yet - click + to add one!</div>';
            }
        }
        
        function setupGoalButtons() {
            document.getElementById('add-goal-btn').addEventListener('click', addNewGoal);
            setupGoalFilterTabs();
        }
        
        let currentGoalFilter = 'active';
        
        function setupGoalFilterTabs() {
            console.log('üîß Setting up goal filter tabs...');
            
            // Create filter tabs dynamically
            const filterContainer = document.querySelector('.goal-filter-tabs');
            if (!filterContainer) {
                console.log('‚ùå Goal filter container not found');
                return;
            }
            
            const goalFilters = [
                { id: 'active', label: 'Aktiv', icon: 'üéØ' },
                { id: 'completed', label: 'Erreicht', icon: 'üèÜ' }
            ];
            
            // Clear and rebuild filter tabs
            filterContainer.innerHTML = '';
            
            goalFilters.forEach(filter => {
                const button = document.createElement('button');
                button.className = 'goal-filter-tab' + (filter.id === 'active' ? ' active' : '');
                button.setAttribute('data-filter', filter.id);
                button.textContent = `${filter.icon} ${filter.label}`;
                button.style.cssText = filter.id === 'active' 
                    ? 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #28a745; color: white; cursor: pointer; font-size: 0.8rem;'
                    : 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                
                button.addEventListener('click', () => {
                    console.log(`üîç Goal filter clicked: ${filter.id}`);
                    
                    // Update all tabs
                    document.querySelectorAll('.goal-filter-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.cssText = 'padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; cursor: pointer; font-size: 0.8rem;';
                    });
                    
                    // Activate clicked tab
                    button.classList.add('active');
                    button.style.cssText = 'padding: 0.5rem 1rem; border: none; border-radius: 20px; background: #28a745; color: white; cursor: pointer; font-size: 0.8rem;';
                    
                    // Update filter
                    currentGoalFilter = filter.id;
                    
                    // Re-render
                    if (window.supabase) {
                        loadAndRenderGoals();
                    }
                });
                
                filterContainer.appendChild(button);
            });
            
            console.log(`‚úÖ Created ${goalFilters.length} goal filter tabs`);
        }
        
        function showAddGoalModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="goal-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üéØ Neues Ziel</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Titel:</label>
                            <input type="text" id="goal-title-input" placeholder="Ziel-Titel..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Beschreibung (optional):</label>
                            <textarea id="goal-description-input" placeholder="Detaillierte Beschreibung..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Kategorie:</label>
                            <select id="goal-category-modal" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="personal">üå± Pers√∂nlich</option>
                                <option value="career">üíº Karriere</option>
                                <option value="health">üí™ Gesundheit</option>
                                <option value="finance">üí∞ Finanzen</option>
                                <option value="education">üìö Bildung</option>
                                <option value="other">üéØ Sonstiges</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Ziel-Datum (optional):</label>
                            <input type="date" id="goal-target-date-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="closeGoalModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                            <button onclick="saveGoal()" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Focus on title input
            document.getElementById('goal-title-input').focus();
        }
        
        function closeGoalModal() {
            const modal = document.getElementById('goal-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveGoal() {
            const titleInput = document.getElementById('goal-title-input');
            const descriptionInput = document.getElementById('goal-description-input');
            const categoryInput = document.getElementById('goal-category-modal');
            const targetDateInput = document.getElementById('goal-target-date-input');
            
            const goalTitle = titleInput.value.trim();
            if (!goalTitle) {
                alert('Bitte Ziel-Titel eingeben!');
                titleInput.focus();
                return;
            }
            
            const description = descriptionInput.value.trim();
            const category = categoryInput.value;
            const targetDate = targetDateInput.value;
            
            const newGoal = {
                id: 'goal_' + Date.now(),
                title: goalTitle,
                description: description,
                category: category,
                target_date: targetDate ? new Date(targetDate).toISOString() : null,
                completed: false,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('goals', newGoal);
                console.log(`‚úÖ Goal added to cloud: ${goalTitle}`);
                closeGoalModal();
                await loadAndRenderGoals(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to add goal:', error);
                alert('Fehler beim Speichern des Ziels!');
            }
        }
        
        async function addNewGoal() {
            showAddGoalModal();
        }
        
        async function syncGoalChange(goalId, checked) {
            try {
                await window.supabase.update('goals', { completed: checked }, goalId);
                console.log(`‚òÅÔ∏è Goal synced: ${goalId} = ${checked}`);
                
                // Refresh display
                setTimeout(async () => {
                    await loadAndRenderGoals();
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Goal sync failed:', error);
            }
        }
        
        // === JOURNAL SYSTEM ===
        async function loadAndRenderJournal() {
            try {
                const entries = await window.supabase.select('journal_entries', '*', 'created_at.desc');
                console.log(`üìä Loaded ${entries?.length || 0} journal entries from cloud`);
                
                if (entries && entries.length > 0) {
                    renderJournalEntries(entries);
                } else {
                    clearJournalLoadingMessages();
                }
            } catch (error) {
                console.error('‚ùå Failed to load journal entries:', error);
            }
        }
        
        function renderJournalEntries(entries) {
            const container = document.getElementById('journal-entries');
            container.innerHTML = '';
            
            entries.forEach(entry => {
                const date = new Date(entry.created_at);
                const dateString = date.toLocaleDateString('de-DE', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const timeString = date.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Parse tags if they exist
                let tagsDisplay = '';
                if (entry.tags) {
                    const tagList = entry.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                    if (tagList.length > 0) {
                        tagsDisplay = `
                            <div style="margin-top: 0.5rem;">
                                ${tagList.map(tag => `<span style="background: #e9ecef; color: #495057; padding: 0.2rem 0.4rem; border-radius: 8px; font-size: 0.7rem; margin-right: 0.3rem;">#${tag}</span>`).join('')}
                            </div>
                        `;
                    }
                }
                
                const entryHTML = `
                    <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: #17a2b8; font-size: 1.1rem;">üìî ${entry.title || 'Journal Entry'}</h4>
                                <small style="color: #666; font-size: 0.8rem;">${dateString} um ${timeString}</small>
                            </div>
                            <button onclick="deleteJournalEntry('${entry.id}')" style="padding: 0.3rem 0.5rem; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">üóëÔ∏è</button>
                        </div>
                        
                        <div style="white-space: pre-wrap; color: #333; line-height: 1.6; margin-bottom: 1rem; font-size: 0.95rem;">${entry.content}</div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                ${entry.mood ? `<span style="background: #fff3cd; color: #856404; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem; border: 1px solid #ffeaa7;">${entry.mood}</span>` : ''}
                            </div>
                            ${tagsDisplay}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', entryHTML);
            });
            
            console.log(`‚úÖ Rendered ${entries.length} journal entries`);
        }
        
        function clearJournalLoadingMessages() {
            const container = document.getElementById('journal-entries');
            if (container) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No journal entries yet - click + to add one!</div>';
            }
        }
        
        function setupJournalButtons() {
            document.getElementById('add-journal-btn').addEventListener('click', addNewJournalEntry);
        }
        
        function showAddJournalModal() {
            // Create modal HTML
            const modalHTML = `
                <div id="journal-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
                    <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üìî Neuer Journal-Eintrag</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Titel (optional):</label>
                            <input type="text" id="journal-title-input" placeholder="z.B. Mein Tag, Gedanken, Reflexion..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Inhalt:</label>
                            <textarea id="journal-content-input" placeholder="Schreibe deine Gedanken, Erlebnisse, Reflexionen..." autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; min-height: 120px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Stimmung (optional):</label>
                            <select id="journal-mood-input" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                                <option value="">-- Stimmung w√§hlen --</option>
                                <option value="üòä Sehr gut">üòä Sehr gut</option>
                                <option value="üôÇ Gut">üôÇ Gut</option>
                                <option value="üòê Neutral">üòê Neutral</option>
                                <option value="üòî Schlecht">üòî Schlecht</option>
                                <option value="üò¢ Sehr schlecht">üò¢ Sehr schlecht</option>
                                <option value="üò§ Gestresst">üò§ Gestresst</option>
                                <option value="üò¥ M√ºde">üò¥ M√ºde</option>
                                <option value="üí™ Motiviert">üí™ Motiviert</option>
                                <option value="ü§î Nachdenklich">ü§î Nachdenklich</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555;">Tags (optional):</label>
                            <input type="text" id="journal-tags-input" placeholder="z.B. work, family, goals, reflection (durch Komma getrennt)" autocomplete="off" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="closeJournalModal()" style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Abbrechen</button>
                            <button onclick="saveJournalEntry()" style="padding: 0.5rem 1rem; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">Speichern</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Set default title to today's date
            const today = new Date().toLocaleDateString('de-DE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('journal-title-input').value = `${today}`;
            
            // Focus on content input
            document.getElementById('journal-content-input').focus();
        }
        
        function closeJournalModal() {
            const modal = document.getElementById('journal-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function saveJournalEntry() {
            const titleInput = document.getElementById('journal-title-input');
            const contentInput = document.getElementById('journal-content-input');
            const moodInput = document.getElementById('journal-mood-input');
            const tagsInput = document.getElementById('journal-tags-input');
            
            const content = contentInput.value.trim();
            if (!content) {
                alert('Bitte Journal-Inhalt eingeben!');
                contentInput.focus();
                return;
            }
            
            const title = titleInput.value.trim() || `Entry ${new Date().toLocaleDateString('de-DE')}`;
            const mood = moodInput.value;
            const tags = tagsInput.value.trim();
            
            const newEntry = {
                id: 'journal_' + Date.now(),
                title: title,
                content: content,
                mood: mood,
                tags: tags,
                created_at: new Date().toISOString()
            };
            
            try {
                await window.supabase.insert('journal_entries', newEntry);
                console.log(`‚úÖ Journal entry added: ${title}`);
                closeJournalModal();
                await loadAndRenderJournal(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to add journal entry:', error);
                alert('Fehler beim Speichern des Journal-Eintrags!');
            }
        }
        
        async function addNewJournalEntry() {
            showAddJournalModal();
        }
        
        async function deleteJournalEntry(entryId) {
            if (!confirm('Delete this journal entry?')) return;
            
            try {
                await window.supabase.delete('journal_entries', entryId);
                console.log(`üóëÔ∏è Journal entry deleted: ${entryId}`);
                await loadAndRenderJournal(); // Refresh
            } catch (error) {
                console.error('‚ùå Failed to delete journal entry:', error);
            }
        }
        
        async function syncTodoChange(todoId, checked) {
            try {
                await window.supabase.update('todos', { completed: checked }, todoId);
                console.log(`‚òÅÔ∏è Todo synced: ${todoId} = ${checked}`);
                
                // Refresh display
                setTimeout(async () => {
                    await loadAndRenderTodos();
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
            }
        }
        
        // === ROUTINES SYSTEM ===
        let currentRoutineType = 'morning';
        
        async function loadAndRenderRoutines() {
            try {
                // Load routine templates
                const templates = await window.supabase.select('routine_templates', '*');
                console.log(`üìä Loaded ${templates?.length || 0} routine templates`);
                
                if (templates && templates.length > 0) {
                    await renderCurrentRoutine(currentRoutineType);
                } else {
                    document.getElementById('current-routine').innerHTML = 
                        '<div style="text-align: center; color: #666; padding: 1rem;">No routines configured</div>';
                }
            } catch (error) {
                console.error('‚ùå Failed to load routines:', error);
            }
        }
        
        async function renderCurrentRoutine(routineType) {
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                // Get templates for this routine type
                const templates = await window.supabase.query(
                    `routine_templates?routine_type=eq.${routineType}&active=eq.true&order=order_index`
                );
                
                if (!templates || templates.length === 0) {
                    document.getElementById('current-routine').innerHTML = 
                        `<div style="text-align: center; color: #666; padding: 1rem;">No ${routineType} routine configured</div>`;
                    return;
                }
                
                // Get today's completions for these templates
                const completions = await window.supabase.query(
                    `routine_completions?date=eq.${today}`
                );
                
                const completionMap = {};
                if (completions) {
                    completions.forEach(comp => {
                        completionMap[comp.template_id] = comp.completed;
                    });
                }
                
                // Render routine items
                const routineContainer = document.getElementById('current-routine');
                routineContainer.innerHTML = '';
                
                templates.forEach(template => {
                    const isCompleted = completionMap[template.id] || false;
                    const routineHTML = `
                        <div class="checkbox-item">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                                   data-template-id="${template.id}" data-routine-type="${routineType}"
                                   onchange="syncRoutineChange('${template.id}', this.checked)">
                            <label style="${isCompleted ? 'text-decoration: line-through; color: #999;' : ''}">${template.text}</label>
                        </div>
                    `;
                    routineContainer.insertAdjacentHTML('beforeend', routineHTML);
                });
                
                console.log(`‚úÖ Rendered ${templates.length} ${routineType} routine items`);
                
            } catch (error) {
                console.error('‚ùå Failed to render routine:', error);
            }
        }
        
        async function syncRoutineChange(templateId, completed) {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Check if completion record exists
                const existing = await window.supabase.query(
                    `routine_completions?template_id=eq.${templateId}&date=eq.${today}`
                );
                
                if (existing && existing.length > 0) {
                    // Update existing
                    await window.supabase.update('routine_completions', 
                        { completed: completed }, 
                        existing[0].id
                    );
                } else {
                    // Create new completion record
                    const newCompletion = {
                        id: `completion_${templateId}_${today}`,
                        template_id: templateId,
                        date: today,
                        completed: completed
                    };
                    await window.supabase.insert('routine_completions', newCompletion);
                }
                
                console.log(`‚òÅÔ∏è Routine synced: ${templateId} = ${completed}`);
                
                // Update UI
                const checkbox = document.querySelector(`[data-template-id="${templateId}"]`);
                if (checkbox) {
                    const label = checkbox.nextElementSibling;
                    if (label) {
                        label.style.textDecoration = completed ? 'line-through' : '';
                        label.style.color = completed ? '#999' : '';
                    }
                }
                
                // Update streak counters instantly (optimistic UI)
                updateStreakInstantly(templateId, completed);
                
                // Also do full recalculation in background
                setTimeout(() => updateRoutineStreaks(), 200);
                
            } catch (error) {
                console.error('‚ùå Routine sync failed:', error);
            }
        }
        
        function setupRoutineToggles() {
            const morningToggle = document.querySelector('[data-routine="morning"]');
            const eveningToggle = document.querySelector('[data-routine="evening"]');
            const routineTitle = document.getElementById('routine-title');
            
            morningToggle?.addEventListener('click', async () => {
                currentRoutineType = 'morning';
                routineTitle.textContent = '‚òÄÔ∏è Morgenroutine';
                
                // Update toggle states
                morningToggle.classList.add('active');
                eveningToggle?.classList.remove('active');
                
                await renderCurrentRoutine('morning');
            });
            
            eveningToggle?.addEventListener('click', async () => {
                currentRoutineType = 'evening';
                routineTitle.textContent = 'üåô Abendroutine';
                
                // Update toggle states
                eveningToggle.classList.add('active');
                morningToggle?.classList.remove('active');
                
                await renderCurrentRoutine('evening');
            });
        }
        
        async function updateRoutineStreaks() {
            try {
                console.log('üìä Calculating routine streaks...');
                
                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                                   'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
                
                // Calculate morning routine streak for current month
                const morningStreak = await calculateMonthlyRoutineStreak('morning', currentYear, currentMonth);
                const eveningStreak = await calculateMonthlyRoutineStreak('evening', currentYear, currentMonth);
                
                // Update UI
                document.getElementById('morningRoutineStreakCount').textContent = morningStreak;
                document.getElementById('morningRoutineStreakDate').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                document.getElementById('eveningRoutineStreakCount').textContent = eveningStreak;
                document.getElementById('eveningRoutineStreakDate').textContent = `${monthNames[currentMonth]} ${currentYear}`;
                
                console.log(`‚úÖ Updated streaks: Morning ${morningStreak}, Evening ${eveningStreak}`);
                
            } catch (error) {
                console.error('‚ùå Failed to update streaks:', error);
            }
        }
        
        async function calculateMonthlyRoutineStreak(routineType, year, month) {
            try {
                // Get first and last day of month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const today = new Date();
                
                // Only count up to today if we're in current month
                const endDate = (year === today.getFullYear() && month === today.getMonth()) 
                    ? today : lastDay;
                
                let completedDays = 0;
                
                // Check each day in the month (up to today)
                for (let day = 1; day <= endDate.getDate(); day++) {
                    const checkDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    // Get all templates for this routine type
                    const templates = await window.supabase.query(
                        `routine_templates?routine_type=eq.${routineType}&active=eq.true`
                    );
                    
                    if (!templates || templates.length === 0) continue;
                    
                    // Get completions for this day
                    const completions = await window.supabase.query(
                        `routine_completions?date=eq.${checkDate}`
                    );
                    
                    // Check if ALL routine items for this type were completed
                    let allCompleted = true;
                    for (const template of templates) {
                        const completion = completions?.find(c => c.template_id === template.id);
                        if (!completion || !completion.completed) {
                            allCompleted = false;
                            break;
                        }
                    }
                    
                    if (allCompleted) {
                        completedDays++;
                    }
                }
                
                return completedDays;
                
            } catch (error) {
                console.error(`‚ùå Failed to calculate ${routineType} streak:`, error);
                return 0;
            }
        }
        
        // Initialize streaks on page load
        async function initializeStreaks() {
            await updateRoutineStreaks();
        }
        
        function updateStreakInstantly(templateId, completed) {
            // Get current streak values
            const morningStreakEl = document.getElementById('morningRoutineStreakCount');
            const eveningStreakEl = document.getElementById('eveningRoutineStreakCount');
            
            // Determine which routine type this template belongs to
            const checkbox = document.querySelector(`[data-template-id="${templateId}"]`);
            const routineType = checkbox?.getAttribute('data-routine-type');
            
            if (!routineType) return;
            
            // Check if all items of this routine type are now completed
            const allCheckboxes = document.querySelectorAll(`[data-routine-type="${routineType}"]`);
            let allCompleted = true;
            allCheckboxes.forEach(cb => {
                if (!cb.checked) allCompleted = false;
            });
            
            // Update streak counter instantly
            const streakEl = routineType === 'morning' ? morningStreakEl : eveningStreakEl;
            const currentStreak = parseInt(streakEl.textContent) || 0;
            
            if (completed && allCompleted) {
                // All items completed - increment streak
                streakEl.textContent = currentStreak + 1;
                console.log(`‚ö° Instant streak update: ${routineType} +1`);
            } else if (!completed && currentStreak > 0) {
                // Item unchecked - decrement streak  
                streakEl.textContent = Math.max(0, currentStreak - 1);
                console.log(`‚ö° Instant streak update: ${routineType} -1`);
            }
        }
    </script>
</body>
</html>